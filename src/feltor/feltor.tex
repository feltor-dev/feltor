%%%%%%%%%%%%%%%%%%%%%definitions%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\input{../common/header.tex}
\input{../common/newcommands.tex}
\usepackage{minted}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%DOCUMENT%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{
The full-F electromagnetic model in toroidal geometry \textsc{Feltor}}
\author{ M.~Wiesenberger and M.~Held}
\maketitle

\begin{abstract}
\textsc{Feltor} is a model for global 3d isothermal electromagnetic full-F gyro-fluid simulations.

\noindent
This document describes the (usage of) programs
contained in \mintinline{bash}{path/to/feltor/src/feltor}
%such
%that there is no need to look
%into the actual source code
and connects
the implemented formulas to relevant journal publications.
\end{abstract}
\tableofcontents

\section{Quick-start}

\mint{bash}|cd path/to/feltor/src/feltor|
\subsection{Compilation}
Compile \mintinline{bash}{feltor.cu} for shared memory. glfw or netcdf output:
\mint{bash}|make feltor device=[gpu,omp] # choose one of gpu or omp|
\noindent Compile \mintinline{bash}{feltor.cu} for shared memory system. Only {\it netcdf} output (no glfw):
\mint{bash}|make feltor_hpc device=[gpu,omp] # choose one of gpu or omp|
\noindent Compile \mintinline{bash}{feltor.cu} for distributed memory systems. Only {\it netcdf} output (no glfw):
\mint{bash}|make feltor_mpi device=[gpu,omp,skl] # choose one of gpu, omp or skl|
\begin{tcolorbox}[title=Note]
    \mintinline{bash}{feltor}, \mintinline{bash}{feltor_hpc} and \mintinline{bash}{feltor_mpi} are
    compilations of the same program for different hardware.
\end{tcolorbox}
\noindent Compile \mintinline{bash}{feltordiag.cu} for shared memory systems.
\mint{bash}|make feltordiag device=[gpu,omp,skl] # choose one of gpu, omp or skl|
\noindent Compile \mintinline{bash}{manufactured.cu} for shared memory systems.
\mint{bash}|make manufactured device=[gpu,omp,skl] # choose one of gpu, omp or skl|
\begin{tcolorbox}[title=Note]
    All our codes link to the \mintinline{bash}{libjsoncpp} library and the serial \mintinline{bash}{libnetcdf} library. \mintinline{bash}{feltor} also links to \mintinline{bash}{libglfw3}
\end{tcolorbox}
\subsection{Usage}
\begin{minted}{bash}
./feltor input.json [output.nc] [initial.nc]
./feltor_hpc input.json output.nc [initial.nc]
echo npx npy npz | mpirun -n np ./feltor_mpi input.json output.nc [initial.nc]
./feltordiag input0.nc [... inputN.nc] diag_output.nc
./manufactured input.json
\end{minted}

\begin{tcolorbox}[title=Note]
    \mintinline{bash}{feltor_mpi} expects the
partition of the total number of processes np into the three directions x, y and z
as an input from the command line.
\end{tcolorbox}
Make sure that \mintinline{bash}{npx*npy*npz==np} and that
they evenly divide the number of grid points in the respective direction! The
number of stages in the multigrid algorithm and the compression parameters further
restrict this choice. Also note that the number of processes in a direction must
not equal the number of grid points in that direction!

\subsection{Input and Output}
Input file format: \href{https://en.wikipedia.org/wiki/JSON}{json} $\rightarrow$ Section~\ref{sec:input_file} \\
Output file format: \href{https://www.unidata.ucar.edu/software/netcdf/docs/}{netcdf-4/hdf5};
\href{http://cfconventions.org/Data/cf-conventions/cf-conventions-1.7/cf-conventions.html}{CF Conventions CF-1.7}
 $\rightarrow$ Section~\ref{sec:output_file} \\

 The programs \mintinline{bash}{feltor}, \mintinline{bash}{feltor_hpc} and \mintinline{bash}{feltor_mpi}
 expect an input file \mintinline{bash}{input.json}.
 The possible fields in the input file are described in Section~\ref{sec:input_file}.
 The program \mintinline{bash}{feltor} plots the results directly to the screen using \mintinline{bash}{glfw3}.
 The programs \mintinline{bash}{feltor_hpc} and \mintinline{bash}{feltor_mpi} write results into
 the output file \mintinline{bash}{output.nc}.
 The output file is described in Section~\ref{sec:output_file}.
 The optional file \mintinline{bash}{initial.nc} can be used to initialize a simulation from an existing file.
 This behavior is described in Section~\ref{sec:restart}.
 All programs write unstructured human readable performance information of the running simulation
 to \mintinline{c++}{std::cout}.
 \\
 \mintinline{bash}{feltordiag} is used to compute post-processing diagnostics that are
 stored in a separate file, see Section~\ref{sec:diagnostics}.
 \\
 \mintinline{bash}{manufactured} is used to test the correct implementation of
 the equations with the method of manufactured solutions, see
 Section~\ref{sec:manufactured}.  The results are written to the terminal in
 \href{https://en.wikipedia.org/wiki/YAML}{yaml} format.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The magnetic field}\label{sec:magnetic}
We assume a three-dimensional flat space with arbitrary coordinate
system $\vec x :=\{x_0, x_1, x_2\}$, metric
tensor $g_{ij}$ and volume element $\sqrt{g} := \sqrt{\det g}$.
Given a vector field $\vec B(\vec x)$ with unit vector $\bhat(\vec x) := (\vec B/B)({\vec x})$
we can define various differential operations.
\begin{table*}[htbp]
\caption{Definitions of geometric operators
with $b^i$ the contra- and $b_i$ the co-variant components of $\bhat$,
$\eps^{ijk}$ the Levi-Civita symbols
and $g^{ij}$ the contra-variant elements of the metric tensor.
% Explicit expressions of these quantities
% depend on the choice of the magnetic field and the underlying coordinate system.
}\label{tab:operators}
%\centering
%\rowcolors{2}{gray!25}{white}
\begin{longtable}{lll>{\RaggedRight}p{7cm}}
%\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Symbol} & \textbf{Definition} \\
\midrule
    Perpendicular Poisson bracket&
    $\left[.,.\right]_\perp$ &
    $\left[f,g\right]_\perp := \bhat \cdot \left(\vec{\vn} f \times\vn g\right) =
    b_i \varepsilon^{ijk}\partial_j f\partial_k g/\sqrt{g}$  \\
    Projection Tensor&
    $h $ & $h^{ij} := g^{ij} - b^ib^j $   \quad \text{ Note }$ h^2=h$\\
    %Alignment Tensor&
    %$t $ & $ t^{ij} := b^ib^j$\\
    Perpendicular Gradient&
    $\np $&
    $ \np f := \bhat\times(\vn f\times \bhat ) \equiv
    h \cdot \vn f$ \\
    Perpendicular Divergence&
    $\np^\dagger $&
    $ \np^\dagger \cdot \vec v := -\nc( h \cdot \vec v) = -\nc\vec v_\perp$ \\
    Perpendicular Laplacian &
    $\Delta_\perp $ &
    $ \Delta_\perp f:= \nc (\np f)
    = \nc( h\cdot\vn f) \equiv -\np^\dagger\cdot\np$  \\
    Curl-b Curvature Operator&
    $\mathcal K_{\vn\times\bhat}$ &
    $\mathcal K_{\vn\times\bhat}(f) := \KK\cn f = \frac{1}{B}(\vn \times \bhat)\cn f$ \\[4pt]
    Grad-B Curvature Operator &
    $\mathcal K_{\vn B} $ &
    $\mathcal K_{\vn B}(f) := \KB \cn f = \frac{1}{B}(\bhat \times\vn \ln B)\cn f$ \\[4pt]
    Curvature Operator&
    $\mathcal K$ &
    $\mathcal{K}(f):=\vec{ K} \cn f =
     \vec{\vn}\cdot\left(\frac{\bhat\times\vec{\vn} f}{B}\right) =\vn \times \frac{\bhat}{B} \cn f$,\\[4pt]
    Parallel derivative&
    $\npar $&
    $ \npar f := \bhat\cdot\vn f$ \quad  Notice $\nc\bhat = -\npar\ln B$ \\
     Parallel Laplacian&
     $\Delta_\parallel $&
     $\Delta_\parallel f:= \vec{\vn} \cdot ( \bhat\bhat\cdot\vec{\vn} f )$\\
\bottomrule
\end{longtable}
\end{table*}
Explicit expressions for the above expressions
depend on the choice of the magnetic field and the underlying coordinate system.
Note that we have
\begin{align}
    \nc \KK
&= -\nc \KB = -\KK\cn\ln B, \\
    \nc\vec{ K} &= 0, \\
    \vec K &= \KB + \KK \\
    \KK - \KB &= \frac{1}{B^2} (\vn \times \vec B), \\
    \npar \ln B &= -\vec\nc\bhat.
    \label{eq:curl_curvature}
\end{align}
The last equality holds if $\vec\nc \vec B = 0$.
Note that in any arbitrary coordinate system we have
\begin{align}
(\vn f)^i = g^{ij}\partial_j f ~, \quad
\nc \vec v = \frac{1}{\sqrt{g}}\partial_i \left(\sqrt{g} v^i\right) ~, \quad
(\vec v \times \vec w)^i = \frac{1}{\sqrt{g}}\varepsilon^{ijk} v_jw_k ~.
%\label{}
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Coordinate system}\label{sec:cylmetric}
We employ cylindrical coordinates \( (R,Z,\varphi) \), with \(\varphi\) anti directed to the geometric toroidal angle ({\bf clockwise} if viewed from above) to
obtain a right handed system. The parametric representation in Cartesian \((x,y,z)\) coordinates is therefore simply:
\begin{align}
 x &= R \hspace{1 mm} \sin{(\varphi)}, &
 y &= R \hspace{1 mm} \cos{(\varphi)}, &
 z &= Z .
\end{align}
Note here that the angle $\varphi = 0$ corresponds to the Cartesian $y$-axis.
The unit
basis vectors and (covariant) metric tensor are:
\begin{align}
 \ehat_R      &= (\sin{(\varphi)} ,   \cos{(\varphi)},0)^T, &
 \ehat_Z      &= ( 0 ,0 ,1 )^T, &
 \ehat_{\varphi} &= ( \cos{(\varphi)} , -\sin{(\varphi)} , 0 )^T,
\\
    (g_{ij}) &= \begin{pmatrix}
  1 & 0 & 0 \\
  0 & 1 & 0 \\
  0 & 0 & R^2
   \end{pmatrix}
% \vn R &= (\sin{(\varphi)} ,   \cos{(\varphi)},0 )^T , &
%  \vnZ &= ( 0 ,0 ,1 )^T,  &
%  \vn{\varphi} &= \frac{1}{R} ( \cos{(\varphi)} , -\sin{(\varphi)} , 0 )^T .
\end{align}
With the help of the metric elements we get a well behaved volume element \(\sqrt{g} = R\). However, we have a coordinate singularity at \(R=0\).
The cylindrical coordinate basis vectors are mutually orthogonal to each other.

\subsection{The flux function}
In cylindrical coordinates the general axisymmetric  magnetic field can be written as (dimensionless)
\begin{align}
 \vec{B} &= \frac{R_0}{R}\left[I(\psi_p) \ehat_{\varphi} + \frac{\partial
 \psi_p}{\partial Z} \ehat_R -  \frac{\partial \psi_p}{\partial R} \ehat_Z\right] ,
\end{align}
which can obviously not be manipulated to be in Clebsch form.
Hence we are dealing with a non-flux aligned coordinate system.
For the sake of clarity we define the poloidal magnetic field \( \vec{B}_p = \frac{R_0}{R}\left( \frac{\partial \psi_p}{\partial Z}\ehat_R - \frac{\partial \psi_p}{\partial R}\ehat_Z\right)
\) and the toroidal magnetic field \(\vec{B}_t =\frac{R_0I}{R} \ehat_{\varphi}\).
\begin{tcolorbox}[title=Note]
With a typically convex function $\psi_p$ (second derivative is
positive), $I(\psi_p)>0$ and the previously defined coordinate system the field
line winding is a {\bf left handed screw} in the positive $\ehat_\varphi$-direction.
Also note that then $\vec B\times\vn\vec B$ points {\bf down}, towards the magnetic X-point,
and we have the {\bf favourable} drift direction (in experiments H-mode
is reached easier in this configuration).
\end{tcolorbox}


We scaled $R$, $Z$ and $R_0$ with $\rho_s = \sqrt{T_e m_i}/(eB_0)$, the
magnetic field with $B_0$, the poloidal flux with $\psi_{p0} = B_0\rho_s \hat
R_0$ and the poloidal equilibrium current streamfunction with $I_0 = B_0 \hat R_0$ (with $\hat R_0 =
\rho_s R_0$ the dimensional major radius).
\subsubsection{Solov'ev equilbrium}\label{sec:solovev}

We have the equilibrium equations in toroidally symmetric, ideal MHD
$\vn p = \vec j\times \vec B$ and $\vn\times\vec B = \beta \vec j$ normalized with $p_0 = n_0 T_0$, and $j_0 = e n_0 c_S$, where we introduce $\beta = n_0 T_0 \mu_0 /B_0^2$.
Note that this normalization is in line with the one later chosen for the gyrofluid
equations but is unnatural for the MHD type equilibrium equations through the introduction
of $\rho_s$ and $\beta$.
\begin{align}
    \vn\times \vec B &= \frac{R_0}{R}\left[ -\Delta^*\psi_p\ehat_\varphi + I_Z \ehat_R - I_R\ehat_Z \right]\equiv \beta \vec j\\
 \beta j_\parallel &= \beta \vec j\cdot \bhat = \beta \frac{\d p}{\d\psi_p} \frac{I(\psi_p)}{B} +
 \beta\frac{\d I}{\d\psi_p} B \quad \text{  Pfirsch-Schl\"uter \& Bootstrap current } \\
 \beta \vec j_\perp &= \beta \bhat\times\left(\vec j\times\bhat\right)=
 \beta \frac{\bhat \times \vn p}{B} \quad\quad\quad \text{ diamagnetic current} \\
 \beta \vec j\times\vec B &= \frac{R_0^2}{R^2}\left[ -\Delta^* \psi_p - I
     \frac{\d I}{\d \psi_p} \right]\vn\psi_p \equiv \beta \frac{\d p}{\d\psi_p}\vn\psi_p =\beta \vn p
\end{align}
from where we recover the Grad-Shafranov equation
\begin{align}\label{eq:GSEdimless}
    -\Delta^*_\perp  \psi_p &= \beta \frac{R^2}{R_0^2} \frac{d p}{d  \psi_p } + I \frac{d I}{d  \psi_p } \equiv \beta \frac{R}{R_0} j_{\hat\varphi}
\end{align}
with $\Delta^*_\perp \psi_p = R\partial_R (R^{-1}\psi_R) + \psi_{ZZ}$.
The Solov'ev assumptions consist of \(A/R_0 = -I \frac{d I}{d  \psi_p }\) and \((1-A)/R_0 = -\frac{d p}{d  \psi_p }\), where \(A\) is a constant~\cite{Cerfon2010,Cerfon2014}.
By integration over \(\psi_p\) we find
$
p(\psi_p) = (A-1)\psi_p/R_0/\beta + p(0)$, %Does that mean that psi_p has to be negative if A=0?
 $I(\psi_p) = \sqrt{-2 A \psi_p/R_0 + 1}$,
 and
    $j_{\hat\varphi} = \left[(A-1)R^2/R_0^2 - A \right]/R/\beta $.
Note that if $\psi_p$, $I(\psi)$ and $p(\psi)$ are a solution to Eq.~\eqref{eq:GSEdimless}
then so are $\mathcal P_\psi \psi_p$ , $\mathcal P_\psi I(\psi_p)$ and $\mathcal P_\psi^2 p(\psi_p)$.
Also note that for $A=0$ the constant current $I$ becomes arbitrary $\mathcal P_I$.

We introduce \(\bar{R} \equiv \frac{R}{R_0}\) and \(\bar{Z} \equiv\frac{Z}{R_0}\)
and thus represent a general solution to Equation~\eqref{eq:GSEdimless} as~\cite{Cerfon2010}
\begin{subequations}
\label{eq:solovev}
\begin{align}
 \psi_p (R,Z) &= \mathcal P_{\psi} R_0 \left[ A\left( \frac{1}{2} \bar{R}^2 \ln{\bar{R}}
   - \frac{1}{8}\bar{R}^4\right)+ \frac{1}{8}\bar{R}^4
   + \sum_{i=1}^{12} c_{i}  \bar{\psi}_{pi}\right],\\
   I(\psi_p) &= \mathcal P_I\sqrt{ - 2A\frac{\psi_p}{R_0\mathcal P_{\psi}} +1},
\end{align}
\end{subequations}
with $\mathcal P_\psi$ a free constant, $\mathcal P_I = \pm \mathcal P_\psi$ for $A\neq 0$ and $\mathcal P_I$ arbitrary for $A=0$ (purely toroidal equilibrium current).
We have
\begin{align}
    p(\psi_p) = \mathcal P_\psi \frac{( A-1)\psi_p}{\beta R_0 } + p(0) \qquad
    j_{\hat\varphi} = \frac{\mathcal P_\psi}{\beta } \left[\frac{(A-1)R}{R_0^2} - \frac{A}{R}\right]
\end{align}
%\rowcolors{2}{gray!25}{white}
\begin{longtable}{>{\RaggedRight}p{7cm}>{\RaggedRight}p{7cm}}
\toprule
  $\bar{\psi}_{p1}=1$
  & $\bar{\psi}_{p7}=8\bar{Z}^6 -140 \bar{R}^2 \bar{Z}^4
                      + 75 \bar{R}^4 \bar{Z}^2 - 15\bar{R}^6\ln{\bar{R}}+ 180 \bar{R}^4 \bar{Z}^2 \ln{\bar{R}} \
                       -120 \bar{R}^2 \bar{Z}^4 \ln{\bar{R}}$\\
%
  $\bar{\psi}_{p2}=\bar{R}^2$ &
  $\bar{\psi}_{p8}=\bar{Z}$ \\
%
  $\bar{\psi}_{p3}=\bar{Z}^2 - \bar{R}^2 \ln{\bar{R}}$ &
  $\bar{\psi}_{p9}=\bar{Z}  \bar{R}^2$\\
%
  $\bar{\psi}_{p4}=\bar{R}^4 -4\bar{R}^2\bar{Z}^2$ &
  $\bar{\psi}_{p10}=\bar{Z}^3 - 3 \bar{Z} \bar{R}^2 \ln{\bar{R}}$\\
  %
  $\bar{\psi}_{p5}=2\bar{Z}^4 - 9 \bar{R}^2\bar{Z}^2 + \
                     3 \bar{R}^4 \ln{\bar{R}} \
                    -12  \bar{R}^2\bar{Z}^2 \ln{\bar{R}}$
  &
$\bar{\psi}_{p11}=3 \bar{Z}\bar{R}^4 - 4\bar{Z}^3\bar{R}^2$\\
%
  $\bar{\psi}_{p6}=\bar{R}^6 -12 \bar{R}^4 \bar{Z}^2
                     + 8  \bar{R}^2 \bar{Z}^4$ &
  $\bar{\psi}_{p12}= 8 \bar{Z}^5 -45 \bar{Z} \bar{R}^4 - \
                       80 \bar{Z}^3 \bar{R}^2\ln{\bar{R}} \
                       +60 \bar{Z} \bar{R}^4\ln{\bar{R}}$ \\
   %& \\
\bottomrule
\end{longtable}

\subsubsection{Polynomial expansion}
As an alternative and in order to better fit experimental equilibria we offer
a polynomial expansion of the magnetic flux function
\begin{subequations}
\label{eq:polynomial}
\begin{align}
    \psi_p(R,Z) &= \mathcal P_\psi R_0\sum_{i=0}^{N_R-1}\sum_{j=0}^{N_Z-1} c_{ij}\bar R^i\bar Z^j\\
   I(\psi_p) &= \mathcal P_I
\end{align}
\end{subequations}
where the number of polynomial coefficients $N_R$ and $N_Z$ can be freely chosen.
Eq.~\eqref{eq:polynomial} and its derivatives can easily be implemented using
\href{file:///home/matthias/Projekte/feltor/doc/dg/html/structdg_1_1_horner2d.html}{Horner's scheme in Feltor}.

\subsubsection{Discussion}
Since Eqs.~\eqref{eq:solovev} and \eqref{eq:polynomial} are given analytically we can numerically evaluate $\psi_p$ and $I$
and all their derivatives
at arbitrary points to machine precision, which is simple to implement and fast to execute.
This translates to an exact representation of the magnetic field and related
quantities like the curvature operators in code. In particular,
the X-point and O-point can be determined to machine
precision via a few Newton iterations.

The choice of the coefficients \(c_{i}\) and \(A\), respectively $c_{ij}$ determines the actual form
of the magnetic field.
We can for example represent single and asymmetric double X-point configurations, force-free states,
field reversed configurations and low and high beta tokamak equilibria.
$R_0$ appears as an artificial scaling factor
(note here that a change in $\rho_s$ changes $R_0$ but not the form or size of
the dimensional equilibrium magnetic field).
The scaling factors $\mathcal P_\psi$ and $\mathcal P_I$ are mainly introduced to maximize the flexibility e.g. to adapt the solution to experimental equilibria or to reverse the sign of the magnetic field.
If an X-point is present, we choose $c_1$ (respectively $c_{00}$) such that
$\psi_p(R_X, Z_X) = 0$ that is the separatrix is given by $\psi_p(R,Z) = 0$.

\subsection{Curvature operators and perpendicular Poisson bracket}
Note that
\begin{align}
    B^R&=B_R = R_0\psi_Z/R \\
    B^Z&=B_Z = - R_0\psi_R/R \\
    B^\varphi &= B_\varphi/R^2 = R_0I/R^2
\end{align}
(contra- and covariant components of $\vec B$).
By construction we have $\partial_\varphi B = 0$ with
\begin{align}
  B = \frac{R_0}{R}\sqrt{ {I^2 + |\vn \psi_p|^2}}.
    \label{}
\end{align}
Furthermore, we have
\begin{align}
  \npar f(R,Z) = \frac{R_0}{RB}[f,\psi_p]_{RZ}\Rightarrow \npar \ln B = \frac{R_0}{RB^2}\left[B, \psi_p\right]_{RZ} = -\vec\nc\bhat.
\end{align}
We allow various simplifications to the curvature operator
for the Solov'ev equilibrium.

%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Toroidal (and negative toroidal) field line approximation}\label{sec:torfieldlineapprox}
The toroidal/negative toroidal field line approximation applies \(\bhat= \pm \ehat_\varphi\) to all perpendicular operators
(e.g.: Poisson bracket, perpendicular elliptic operator and curvature operators)
but retains the full expression for the magnetic field unit vector \(\bhat\)
for parallel operators (\(\npar\) and \(\Delta_\parallel\)).
\begin{tcolorbox}[title=Note]
We allow the negative sign $-\ehat_\varphi$ to enable a sign reversal of the magnetic field, see Section~\ref{sec:field_reversal}.
\end{tcolorbox}
In cylindrical coordinates that is
\begin{align}
[f,g]_\perp \equiv [f,g]_{RZ} &= \pm\frac{1}{R} \left(\partial_R f\partial_Z g - \partial_Z f\partial_R g\right) \\
\np f &= \partial_R f \ehat_R + \partial_Z f \ehat_Z \\
\Delta_\perp f &= \frac{1}{R}\partial_R \left( R \partial_R f\right) + \partial_Z(\partial_Z f)
\label{}
\end{align}
The curl of $\bhat$ reduces to
%\begin{align}
 $\vn\times\bhat = -  \frac{\pm 1}{R} \ehat_Z$.
%end{align}
This simplifies the curvature operators to:
\begin{align}
\vec{{K}}_{{\vn\times\bhat}}  &=  -  \frac{\pm 1}{B R} \ehat_Z , &
\vec{ {K} }_{\vn  B}  &=  -\frac{\pm 1}{B^2}\frac{\partial B}{\partial Z}\ehat_R +\frac{\pm 1}{B^2} \frac{\partial B}{\partial R}\ehat_Z &
%\ehat_\varphi \times \vn B, &
\vec{ {K} } &= \KB  +\KK ,
%\\
%\mathcal{K}_{{\vn\times\bhat}}(f)   &=  -  \frac{1}{B R} \frac{\partial f}{\partial Z},&
%\mathcal{K}_{\vn  B} (f)  &= \frac{1}{B} \left[\ln B, f \right]_{RZ},&
%\mathcal{K} (f) &=\frac{1}{B} \left[\ln B, f \right]_{RZ}-  \frac{1}{B R} \frac{\partial f}{\partial Z} ,
\end{align}
and
\begin{align}
    \nc \KK &= \frac{\pm 1}{R B^2} \frac{\partial B}{\partial Z} = -\nc \KB,
\end{align}
which results in a vanishing divergence of the curvature operators \( \nc \vec{ {K} } = 0\).

Note that in an actual toroidal field we have
\begin{align}
  \vec B(R) := \pm \frac{R_0}{R} \ehat_\varphi
  \label{}
\end{align}
We then have $\bhat = \pm\ehat_\varphi$ and the curvature operators further
simplify to
\begin{align}
  \KK = \KB = -\frac{\pm 1}{R_0} \ehat_Z =
\vec{  K}/2\\
  \nc\KK=
    \npar \ln B = 0
    \label{}
\end{align}
Note: the negative sign is automatically chosen in code if $I(R_0, 0)<0$.

\subsubsection{Low beta approximation}\label{sec:lowbetaapprox}
In this approximation we apply the toroidal field line approximation
as in Section
\ref{sec:torfieldlineapprox}
but approximate the curvature operator $ \KK \approx \bhat\times\vec \kappa$
  with
  $\vec \kappa := \bhat \cn\bhat = -\bhat \times( \vn\times \bhat)$.
For an isotropic pressure plasma \(\vec{P} = \vec{I} P_\perp + \vec{b} \vec{b} P_\Delta \approx \vec{I} P_\perp\) and with the definition of the plasma beta parameter
\(\beta = \frac{P}{B^2/(2 \mu_0) } \)
we can rewrite the curvature to
\begin{align}
    \vec{\kappa} &\approx \frac{\beta}{2} \vn \ln(P) +\np \ln{B} .
\end{align}
In low beta plasmas \(\beta\ll1\) the curvature reduces to:
\begin{align}
    \vec{\kappa} & \approx \np \ln{B} .
\end{align}
This simplifies the curvature operators to:
\begin{align}
\KK \approx
\vec{ {K} }_{\vn  B}  &\approx  -\frac{1}{B^2}\frac{\partial B}{\partial Z}\ehat_R +\frac{1}{B^2} \frac{\partial B}{\partial R}\ehat_Z &
{K} (f) &\approx 2{K}_{\vn  B} (f) , &
    \vn\times\bhat \cdot \KB &= 0.
\end{align}
The divergence over the curvature vanishes \( \nc \vec{ {K} } = 0\) only if \( \nc \KB   = 0\).
In general, the divergence \( \nc \vec{ {K} } \approx 0\) is only approximately vanishing.
\subsubsection{True perpendicular terms} \label{sec:trueapprox}

Without any approximations we have
\begin{align}
b^R = {\frac{\partial \psi}{\partial Z}}\left(I^2+|\vn\psi|^2\right)^{-1/2} \quad
b^Z = -{\frac{\partial \psi}{\partial R}}\left(I^2+|\vn\psi|^2\right)^{-1/2} \quad 
b^\varphi = \frac{I}{R}\left(I^2+|\vn\psi|^2\right)^{-1/2} \\
\vec\nc\bhat = -\npar \ln B = -\frac{R_0}{R B^2}[B,\psi_p]_{RZ} \\
\left({\vn\times\bhat}\right) \cdot\bhat =
    (I'(\vn\psi_p)^2 - I \Delta_\perp^* \psi_p)\frac{ R_0^2}{R^2B^2} \propto 1/R_0
\label{}
\end{align}
where for the last
estimate we inserted the Grad-Shafranov equation and the Solov'ev assumptions.
We can then insert $\bhat$ into the exact definitions for $[.,.]_\perp$, $\np$ and $\Delta_\perp$ from Section~\ref{sec:magnetic}.

For the curvature terms we can explicitly write
\begin{align}
K_{\vn B}^R &= -\frac{R_0 I}{B^3R}\frac{\partial B}{\partial Z} \equiv -\frac{1}{B^2}\frac{\partial B}{\partial Z}b^\varphi \\
K_{\vn B}^Z &= \frac{R_0 I}{B^3R}\frac{\partial B}{\partial R}\equiv \frac{1}{B^2}\frac{\partial B}{\partial R}b^\varphi \\
K_{\vn B}^\varphi &= \frac{R_0}{B^3R^2}\left(
      \frac{\partial \psi}{\partial Z} \frac{\partial B}{\partial Z}
    + \frac{\partial \psi}{\partial R}\frac{\partial B}{\partial R}\right)
%\equiv \frac{1}{B^2R}\left(\bhat^R \frac{\partial B}{\partial Z} - \bhat^Z \frac{\partial B}{\partial R}\right)\quad %contravariant phi component
\label{}
\end{align}
and
\begin{align}
K_{\vn\times\bhat}^R &= \frac{R_0 }{RB^3}\left( B\frac{\partial I}{\partial Z} -I\frac{\partial B}{\partial Z}\right) \\
K_{\vn\times\bhat}^Z &= \frac{R_0 }{RB^3} \left( I\frac{\partial B}{\partial R} - B\frac{\partial I}{\partial R} \right)\\
K_{\vn\times\bhat}^\varphi &= \frac{R_0}{R^2B^2}\left(
+ \frac{1}{B}\frac{\partial\psi}{\partial Z} \frac{\partial B}{\partial Z}
+ \frac{1}{B}\frac{\partial \psi}{\partial R}\frac{\partial B}{\partial R}
-R\frac{\partial}{\partial R}\left(\frac{1}{R}\frac{\partial\psi}{\partial R}\right) 
- \frac{\partial^2 \psi}{\partial Z^2}
\right) \\
\vec\nc\KK &= -\vec\nc\KB= -\KK\cn\ln B = \frac{R_0}{RB^3}[I,B]_{RZ}
%contravariant phi component
\label{}
\end{align}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The model} \label{sec:model}
\subsection{Conservative form}
We scale all spatial lengths by $\rho_s = \sqrt{T_e m_i}/(eB_0)$ and time by the ion gyro-frequency $\Omega_0 = eB_0/m_i$.
The magnetic field is scaled with $B_0$, densities with $n_0$ and the parallel velocity is scaled with $c_s = \sqrt{T_e/m_i}$.
The potential is scaled with $\hat \phi = e/T_e$ and the vector potential with
$\hat A_\parallel = \rho_s B_0$.
We introduce the dimensionless parameters
\begin{align}
  \tau_a = \frac{T_a}{z_aT_e}~,\quad \mu_a = \frac{m_a}{z_am_i}\text{ and }
  \beta:=\frac{\mu_0 n_0 T_e}{B_0^2}
  \label{}
\end{align}
where $a\in\{e,i\}$ is the species label and $z$ is the charge number.
Omitting the species label we arrive at (dividing the density equation by $\Omega_0n_0$ and the velocity equation by $\Omega_0 c_s$)
\begin{tcolorbox}[ams align,
colback=yellow!10!white, colframe=red!50!black,
        highlight math style= {enhanced, %<-- needed for the ’remember’ options
        colframe=red,colback=red!10!white,boxsep=0pt}, title=Model equations
        ]
\frac{\partial}{\partial t} N &+ \vec\nc\left( N \left(
    \vec u_E + \vec u_K + \vec u_{C} + U_\parallel\left(\bhat + {\vec b}_\perp\right)\right)\right) = \Lambda_N + S_N \\
    \mu \frac{\partial}{\partial t} \left(N U_\parallel\right) &+ \mu \nc \left( NU_\parallel \left(
    \vec u_E + \vec u_K + \vec u_{C} + U_\parallel\left(\bhat + {\vec b}_\perp\right)
    \right)\right)  \nonumber \\
    &+ 2\mu \nc ( NU_\parallel \vec u_{\vn\times\bhat})
    -\mu NU_\parallel\nc \vec u_{\vn\times\bhat}
    + \mu NU_\parallel\mathcal K_{\vn\times\bhat}(\psi) \nonumber\\
    =& -\tau \left(\bhat + {\vec b}_\perp\right)\cn N
    -N \left( \left(\bhat+{\vec b}_\perp\right)\cn \psi + \frac{\partial A_\parallel}{\partial t}\right)
    - \eta n_e(N_iU_{\parallel,i}-n_eu_{\parallel,e})
    \nonumber\\
    &+ \Lambda_{\mu NU}
\label{}
\end{tcolorbox}
with
\begin{align}
\vec u_E := \frac{\bhat\times\vn\psi}{B},\quad
\vec u_{K} := \tau \left(\KB + \KK\right)=\tau\vec{ K}  ,\quad  %\nonumber\\
\vec u_C := \mu U_\parallel^2\KK,\nonumber\\
\vec u_{\vn\times\bhat} := \tau\KK,\quad
{\vec b}_\perp = \frac{\vn\times A_\parallel \bhat}{B} = A_\parallel \KK + \frac{\vn A_\parallel \times \bhat}{B}.
\label{}
\end{align}

The electric potential \(\phi\) and parallel magnetic vector potential \(A_\parallel\) are
computed by the polarisation and Ampere equations (with $q_e=-e$ and $q_i=+e$)
\begin{align}
 -\nc\left(\frac{\mu_iN_i}{B^2} \np \phi\right) &=  \Gamma_{1,i} N_i -n_e, \quad \Gamma_{1,i}^{-1} := 1-\frac{1}{2}\mu_i\tau_i\Delta_\perp , \\
  -\frac{1}{\beta} \Delta_\perp A_\parallel &= \left(N_i U_{\parallel,i}-n_e u_{\parallel,e} \right)
  \label{eq:polarisation_dimensional}
\end{align}
Given $\phi$ we define the generalised electric potential
\begin{align}
    \psi_e := \phi,\quad \psi_i&:= \Gamma_{1,i} \phi - \frac{\mu_i }{2}\left(\frac{\np\phi}{B}\right)^2
\end{align}
In total
we have an isothermal 3d gyro-fluid model with up to 2nd order FLR effects
on in the electric potential $\phi$ and 0th order FLR effects in the parallel magnetic
potential $A_\parallel$.
We have the continuity equation for the electron density \(n_e\) and the ion gyro-centre
density \(N_i\) and the momentum conservation equation for
the parallel electron velocity \(u_{\parallel,e}\) and the parallel ion gyro-centre velocity \(U_{\parallel,i}\)~\cite{WiesenbergerPhD, HeldPhD}.
\begin{tcolorbox}[title=Note]
    Throughout this work we assume the ions have unit charge $z=1$.
\end{tcolorbox}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Diffusive terms}\label{sec:dissres}
Since the gyro-fluid derivation does not include collisional terms we
copied the parallel resistive and viscous terms from the Braginskii fluid equations~\cite{Braginskii1965}.
The electron-ion and ion-ion collision frequencies are given by
$\nu_{ei} = \sqrt{2} z^2 e^4 \ln \Lambda/ (12\pi^{3/2} \sqrt{m_e} \epsilon_0^2) n_e /T_e^{3/2}$, $\nu_{ee} = \nu_{ei}/\sqrt{2}$
and
$\nu_{ii} =  z^4 e^4 \ln \Lambda/ (12\pi^{3/2} \sqrt{m_i} \epsilon_0^2) n_i /T_i^{3/2} = \nu_{ei} \sqrt{|\mu_e|}/ ( \tau_i^{3/2} \sqrt{2})$.
We define with the parallel Spitzer resistivity
$\eta_\parallel := 0.51\frac{ m_e \nu_{ei}}{n_e e^2}$ and the parallel electron and ion viscosities
$\mu_{\parallel,e}:=0.73\frac{n_eT_e}{\nu_{ei}}$ and $\mu_{\parallel,i} = 0.96\frac{n_iT_i}{\nu_{ii}}$~\cite{Braginskii1965}
\begin{subequations}
\begin{align}
    \eta&:=\frac{en_0\eta_\parallel}{B_0} = 0.51\frac{\nu_{ei,0}}{\Omega_{ce}}=
    8.45\cdot 10^{-5}\ln \lambda \left(\frac{n_0}{10^{19}\text{m}^3}\right)
    \left(\frac{T_e}{\text{eV}}\right)^{-3/2}
    \left(\frac{B_0}{\text{T}}\right)^{-1},
    \label{eq:resistivity}\\
    \nu_{\parallel,e}&:=\frac{\mu_{\parallel,e,0}}{m_e n_0\rho_s^2\Omega_{ci}}
    = 0.73 \frac{\Omega_{ce}}{\nu_{ei,0}} = \frac{0.37}{\eta}
    \label{eq:nu_parallele}\\
    \nu_{\parallel,i}&:=\frac{\mu_{\parallel,i,0}}{m_i n_0 \rho_s^2\Omega_{ci}}
    = 0.96 \frac{\Omega_{ci}}{\nu_{ii,0}} = {\tau_i^{3/2}}{\sqrt{|\mu_e|}}
    \frac{0.69}{\eta}
    \label{eq:nu_paralleli}
\end{align}
\end{subequations}
with $\ln \lambda \approx 10$.
Note that $\nu_\parallel/N$ represents a kinematic viscosity and is a factor $\sqrt{|\mu_e|}$ smaller for ions than for electrons.
The dynamic viscosity $\mu\nu_\parallel$ is larger for ions than for electrons.

 The parallel current \(J_{\parallel}:=N_iU_{\parallel,i} - n_eu_{\parallel,e}\)
 determines the parallel resistive terms to $R_\parallel:= n_e\eta J_{\parallel}$
 (This form both conserves parallel momentum and vanishes for zero current but
 does not lead to a quadratic energy dissipation term).

 Note also that since $A_\parallel/\mu_e$ is (potentially) much larger than $u_e$
 it is important that the diffusive operators act on $u_e$ rather than $w_e$.
 The latter essentially would entail that electron diffusion acts on $A_\parallel$.

 For the perpendicular terms we use ad-hoc artificial numerical diffusion (or
 order s) for numerical stabilisation %and add numerical parallel diffusion
 %to the density equation.
\begin{align}
\label{eq:perpdiffNU}
\Lambda_{n_e} &=  -\nu_{N,\perp}(-\Delta_\perp)^s n_e + \nu_{N,\parallel}\Delta_\parallel n_e = -\nc ( \vec j_{\nu,n_e}) \\
\Lambda_{N_i} &=  -\nu_{N,\perp}(-\Delta_\perp)^s N_i + \nu_{N,\parallel}\Delta_\parallel N_i= -\nc ( \vec j_{\nu,N_i}) \\
\Lambda_{\mu_e n_e u_e} &=  -\mu_e\nu_{U,\perp}(-\Delta_\perp)^s u_{\parallel,e} + \mu_e \nu_{\parallel,e} \Delta_\parallel u_{\parallel,e}  - \nc ( \mu_e u_{\parallel,e} \vec j_{\nu,n_e})\\
\Lambda_{\mu_i N_i U_i} &=  -\mu_i\nu_{U,\perp}(-\Delta_\perp)^s U_{\parallel,i} + \mu_i \nu_{\parallel,i} \Delta_\parallel U_{\parallel,i}  - \nc ( \mu_i U_{\parallel,i} \vec j_{\nu,N_i})
\end{align}
Here we separately identify the mass diffusion coefficient and the viscous
coefficient, hence the Schmidt number \(\mathit{Sc}_\parallel:=
\frac{\nu_{U,\perp}}{\nu_{N,\perp}}\).
We have
\begin{align}
    N\Lambda_U &=  -\nu_{U,\perp}(-\Delta_\perp)^s U_{\parallel} +  \nu_{\parallel} \Delta_\parallel U_{\parallel}  + \nu_{N,\parallel} \npar N \npar U_{\parallel} + \nu_{N,\perp}\np\left( (-\Delta_\perp)^{s-1}N\right) \cn U_{\parallel}
\end{align}
Note here that the latter two terms have the form of advection terms for the parallel velocity $\vec j_{\nu,N}\cn U_\parallel$.

We do not derive resistive drifts in the gyro-fluid approach.
The drift-fluid corresponding resistive drift gives an order-of-magnitude estimate for $\nu_\perp$.
We have  $D_i = \rho_i^2 \nu_{ii}$ and $T_{i0} = T_{e0}$.
By dividing by $\rho_s^2 \Omega_{ci}$ we arrive at $\nu_\perp = \nu_{ii0}/\Omega_{ci}$.
\begin{align}
\nu_\perp =
5\cdot 10^{-3} \ln \lambda
\left(\frac{n_0}{10^{19}\text{m}^3}\right)
\left(\frac{T_e}{\text{eV}}\right)^{-3/2}
\left(\frac{B_0}{\text{T}}\right)^{-1}
\left(\frac{m_i}{m_H}\right)^{1/2},
\end{align}

\subsection{Implemented form}
We use a form that avoids derivatives on the product of two
functions for which we have no boundary condition.
We further split the terms into advection terms, for which an upwind scheme can be
used to implement and divergences.
\begin{subequations}
    \begin{align}
    \frac{\partial}{\partial t} N =&
    %\left[
        -\left( \frac{\vec b\times\vn \psi}{B}
        + \tau \vec K + \mu U_\parallel^2 \vec K_{\vn\times\bhat} +
        U_\parallel {\vec b}_\perp
    \right)\cn N
%\right.
\nonumber \\ &
%\left.
    \vphantom{\frac{\vec b\times\vn \psi}{B}} %PHANTOM
        - N \left( \mathcal K(\psi)
           +\mu U_\parallel^2\nc \vec{ K_{\vn\times\bhat}}
        +\mu \mathcal K_{\vn\times\bhat}(U_\parallel^2)
        + U_\parallel \nc { \vec b}_\perp
    + {\vec b}_\perp\cdot\nabla U_\parallel \right)
%\right.
\nonumber \\&
%\left.
    \vphantom{\frac{\vec b\times\vn \psi}{B}} %PHANTOM
    - N\npar U_\parallel - U_\parallel \npar N - NU_\parallel \nc \bhat
    - \nu_{N,\perp}(-\Delta_\perp)^s N + \nu_{N,\parallel}\Delta_\parallel N + S_N
%\right] (1-\chi_s - \chi_w)
% \nonumber \\&
%    + \omega_s\chi_s( N_{sh} - N) + \omega_w \chi_w (1-N)
    , \label{eq:EgyrofluidN}\\
%%%%%%%%%%%%%%%%%%%%%%%
    \frac{\partial}{\partial t} W_\parallel =&
  %\left[
      -\left( \frac{\vec b\times\vn \psi}{B}
          + \tau \vec K + (\mu U_\parallel^2 + 2\tau) \vec K_{\vn\times\bhat} +
        U_\parallel {\vec b}_\perp
    \right)\cn U_\parallel
%\right.
\nonumber \\&
%\left.
    \vphantom{\frac{\vec b\times\vn \psi}{B}} %PHANTOM
    - U_\parallel \left( 2\tau \mathcal K_{\vn\times\bhat}(\ln N)
        +\tau \nc\vec{ K_{\vn\times\bhat}}
        + \mathcal K_{\vn\times\bhat}(\psi)
        \right)
        - \frac{1}{\mu} {\vec b}_\perp\cn \psi% \nonumber\\
        -\frac{\tau}{\mu} {\vec b}_\perp\cn \ln N
%\right.
\nonumber \\&
%\left.
    \vphantom{\frac{\vec b\times\vn \psi}{B}} %PHANTOM
        - \frac{1}{2}\npar U_\parallel^2
        - \frac{1}{\mu} \npar \psi% \nonumber\\
        -\frac{\tau}{\mu} \npar \ln N
        - \frac{\eta}{\mu} \frac{n_e}{N}(N_iU_{\parallel,i} - n_eu_{\parallel,e})
%\right.
\nonumber \\&
\vphantom{\frac{\vec b\times\vn \psi}{B}} %PHANTOM
        + \frac{\nu_\parallel}{N} \Delta_\parallel U_\parallel
        + \frac{\nu_{N,\parallel}}{N} \npar N \npar U_\parallel
        - \frac{\nu_{U,\perp}}{N}(-\Delta_\perp)^{s} U_\parallel
        + \frac{\nu_{N,\perp}}{N} \np (-\Delta_\perp)^{s-1} N \cn U_\parallel
\nonumber \\&
    - \frac{U_\parallel}{N} S_N
%\right] (1-\chi_s - \chi_w)
 %\nonumber \\&
    %+ \omega_s\chi_s ( U_{\parallel}^{sh} - U_\parallel) -\omega_w \chi_wU_\parallel
    ,
        \label{eq:EgyrofluidU} \\
        W_\parallel&:= \left( U_\parallel + \frac{A_\parallel}{\mu}\right)
    \end{align}
    \label{eq:Egyrofluid}
\end{subequations}
together with
%$\vec u_E\cn f = [ \psi, f]_\perp$,
%${\vec b}_\perp\cdot \nabla f = A_\parallel \mathcal K_{\vn\times\bhat}(f) + \frac{1}{B}[ f, A_\parallel]_\perp$
%and
$\nc { \vec b}_\perp = A_\parallel \vec \nc\vec{ { K}_{\vn\times\bhat}} - \mathcal K_{\vn B}(A_\parallel) $
and
\begin{subequations} \label{eq:elliptic}
  \begin{align}
    -\nc\left( \frac{N_i}{B^2}\np \phi \right) &= \Gamma_{1,i} N_i - n_e, \quad\quad
    \Gamma_{1,i}^{-1} = 1-\frac{1}{2}\tau_i\mu_i \Delta_\perp \\
    \psi_e = \phi, \quad \psi_i &= \Gamma_{1,i}\phi -\frac{\mu_i}{2}\frac{(\np\phi)^2}{B^2} \\
    \left(\frac{\beta}{\mu_i}N_i - \frac{\beta}{\mu_e}n_e-\Delta_\perp\right)
    A_\parallel &= \beta\left(N_iW_{\parallel,i}-n_e w_{\parallel,e}\right)
  \end{align}
\end{subequations}
\begin{tcolorbox}[title=Note]
The negative signs make the operators in Eqs.~\eqref{eq:elliptic} positive definite.
\end{tcolorbox}

\subsection{Scale invariance}
\subsubsection{Sign reversals of the magnetic field}\label{sec:field_reversal}
If we change the direction of the magnetic field vector $\bhat$, we immediately see that all perpendicular
drifts and $U_\parallel\bhat$ change directions. On the other side, the diffusive and resistive terms remain unchanged.
Without resistivity and diffusion a change in direction of the magnetic field thus corresponds to
a time reversal $t\rightarrow t'=-t$.
In the code $\bhat$ changes sign by using both $-\mathcal P_\psi$ and $-\mathcal P_I$.

Also note that changing the sign of the magnetic field only in the parallel derivatives $\npar \rightarrow -\npar$ does not
have any effect. This can be seen by simply renormalizing $U_\parallel'=-U_\parallel$. This reverts the equations back to the original equations.
\subsubsection{Scaling of density}
If $N, U_\parallel, \phi, A_\parallel$ are a solution to the model equations
then so are $N'=\alpha N$, $U_\parallel'=U_\parallel$, $\phi'=\phi$ and $A_\parallel'=A_\parallel$ with the changed parameters $S_N' = \alpha S_N$, $\eta' = \eta/\alpha$ and $ \beta' = \beta/\alpha$. If $N$
has a Dirichlet boundary condition, then $N'$ satisfies a correspondingly scaled boundary condition.
%\subsubsection{Helicity}
% MW: think about it again, the magnetic field reverses direction by a mirror transformation (so we cannot just view the tokamak in a mirror)
%The standard helicity of the magnetic field would be a right handed screw,
%where the magnetic field and the toroidal plasma current point in the clockwise
%direction if the tokamak is seen from above.
%The helicity should however not have any influence on the plasma dynamics. With
%a mirror transformation (view the tokamak in a mirror) we should be able
%to transform the solution to one with reversed helicity.

\section{The Input file} \label{sec:input_file}
Input file format: \href{https://en.wikipedia.org/wiki/JSON}{json}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Magnetic field} \label{sec:geometry_file}

The json structure of the geometry parameters depends on which expansion for $\psi_p$ is chosen Eq.~\eqref{eq:solovev} or Eq.~\eqref{eq:polynomial}.
In addition we have an option to read the geometry parameters either from an external
file or directly from a field in the input file.
\begin{minted}[texcomments]{js}
"magnetic_field":
{
    // toroidal field approximation \ref{sec:torfieldlineapprox}
    // (automatically detects negative direction)
    "curvmode": "toroidal",
    // no approximation \ref{sec:trueapprox}
    // requires significantly more resolution in Nz
    "curvmode": "true",
    // low beta approximation \ref{sec:lowbetaapprox}
    "curvmode": "low beta",

    // Tells the parser that the geometry parameters are located in an
    // external json file (relative to where the program is
    //  executed) containing the geometry parameters to read
    "input": "file",
    "file": "path/to/geometry.json",
    "scale" : 1000 // conversion factor multiplied to $R_0$ read from file (can be used to convert $R_0$ from m to $\rho_s$
    //
    // Tells the parser that the geometry parameters are located in the
    // same file in the params field (recommended option)
    "input": "params",
    "params":
    // \ldots
}
\end{minted}
\noindent
The external file, respectively the ``params'' field in the input file
contains
\begin{minted}[texcomments]{js}
{
    "PP" : 1.0,  // Prefactor $\mathcal P_\psi$ for $\psi_p$
    "PI" : 1.0,  // Prefactor $\mathcal P_I$ for $I$
    "R_0" : 200.0, // Major radius $R_0$. (see remark below for unit)
    "elongation" : 1.0,
    // Elongation $e$, used in the initial guess for the location of the
    // X-point $Z_X = -1.1 ea$
    "triangularity" : 0.0,
    // Triangularity $\delta$, used in the initial guess for the location of
    // the X-point $R_X = R_0-1.1\delta a$
    "inverseaspectratio" : 0.16667,
    // minor to major radius $a/R_0$ (used to compute $a$ from $R_0$)
    "description" : "standardX",
    // Standard configuration with X-point located at the bottom
    "description" : "centeredX",
    // X-point located in the middle of the domain

    // Tell the magnetic field generation to use solovev expansion for the
    // flux function
    "equilibrium" : "solovev",
    "A" :  0.0, // Solovev parameter in Eq. \eqref{eq:solovev} \\
    "c" : [ /* 12 Solovev coefficients in Eq. \eqref{eq:solovev} */ ]
    //
    // Tell the magnetic field generation to use the polynomial expansion for
    // the flux function:
    "equilibrium" : "polynomial"
    "M" : 4, // Number of polynomial coefficients in $R$ in Eq. \eqref{eq:polynomial}
    "N" : 4, // Number of polynomial coefficients in $Z$ in Eq. \eqref{eq:polynomial}
    "c" : [ /* MN real coefficients in Eq. \eqref{eq:polynomial} */]
}
\end{minted}
\begin{tcolorbox}[title=Unit of $R_0$]
If the magnetic parameters are read from an external file (i.e. the "input"
parameter is set to "file") then $R_0$ is multiplied with the "scale" value
that is though to convert the unit of $R_0$ to $\rho_s$.

If the "input" parameter is set to "params" then $R_0$ is assumed to already be
in units of $\rho_s$. No "scale" value needed then.
\end{tcolorbox}

%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Spatial grid} \label{sec:spatial}
We define the simulation box as
The spatial grid is an equidistant discretization of the 3D Cylindrical
product-space
$[ R_{\min}, R_{\max}]\times [Z_{\min}, Z_{\max}] \times [0,2\pi]$,
where we define
\begin{align} \label{eq:box}
    R_{\min}&=R_0-\varepsilon_{R-}a\quad
    &&R_{\max}=R_0+\varepsilon_{R+}a\nonumber\\
    Z_{\min}&=-\varepsilon_{Z-}a\quad
    &&Z_{\max}=\varepsilon_{Z+}a
\end{align}
where $a$ is the minor radius and
the $\varepsilon$ are free parameters to be specified by the user.
We use an equal number of Gaussian nodes in $R$ and $Z$ and equidistant
planes in $\varphi$ (no dG).
\begin{minted}[texcomments]{js}
"grid" :
{
    "n"  :  3, // The number of Gaussian nodes in R and Z (3 is a good value)
    "Nx"  : 48, // Number of cells in R (increase if simulations crash)
    "Ny"  : 48, // Number of cells in Z (increase if simulations crash)
    "Nz"  : 8,  // Number of planes in $\varphi$ (there is no dG in third dimension)
    // Nz determines dt since parallel diffusion / velocity dominates time step
    "scaleR"  : [1.1,1.1], // $[\varepsilon_{R-}, \varepsilon_{R+}]$ scale left and right boundary in R in Eq.\eqref{eq:box}\\
    "scaleZ"  : [1.2,1.1], // $[\varepsilon_{Z-}, \varepsilon_{Z+}]$ scale lower and upper boundary in Z in Eq.\eqref{eq:box}
}
\end{minted}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{The boundary region} \label{sec:boundary}
Setting the boundary conditions in an appropriate manner is probably the most
fiddly task in setting up a simulation. Things to consider are:
\begin{itemize}
\item implementation of boundary conditions in the FCI scheme (since
    magnetic field-lines do not intersect the simulation domain perpendicularly)
    In particular in the corners of the domain where fieldlines enter and leave
    the domain in a short distance.
\item how to dissipate density that reaches out of the SOL into the wall region
\item whether and how to implement sheath boundary conditions
\end{itemize}
We have several tools to try to address the above issues
\begin{itemize}
    \item define homogeneous boundary conditions on the simulation boundary
    \item define what part of the domain is inside or outside the wall
    \item define what part of the domain is inside or outside the sheath region
    \item dampen the dynamics in the wall region to the boundary conditions
    \item dampen the dynamics in the sheath region to the boundary conditions
    \item penalize the equations
    \item modify the magnetic field in the wall region
    \item various ways of implementing the parallel boundary condition
\end{itemize}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{The wall region}\label{sec:wall}
\begin{minted}[texcomments]{js}
"boundary":
{
    "wall" :
    {
        // no wall region
        "type" : "none"
    }
}
\end{minted}
Being a box, our computational domain is in particular not aligned with the
magnetic flux surfaces. This means that particularly in the corners of
the domain the field lines inside the domain are very short (in the
sense that the distance between the entry point and leave point is short).
It turns out that this behaviour is numerically disadvantageous (may
blow up the simulation in the worst case) in the
computation of parallel derivatives.
In order to remedy this situation
we propose a penalization method to model the actual physical wall.
We define an approximation to the step function with a transition layer of radius $a$
around the origin
\begin{align}
\Theta_a(x) := \begin{cases}
    0 & \text{ for } x \leq -a  \\
    \frac{1}{32 a^7}  \left(16 a^3-29 a^2 x+20 a x^2-5 x^3\right) (a+x)^4
    &\text{ for } -a<x\leq a \\
    1 & \text{ for } x > a
\end{cases}
    \approx H(x)
\label{eq:approx_heaviside}
\end{align}
where $H(x)$ is the Heaviside step function.
%An integral of this function is
%\begin{align}
%\theta_a(x) := \begin{cases}
%    0 &\text{ for } x \leq -a \\
%    \frac{1}{256 a^7} \left(35 a^3-47 a^2 x+25 a x^2-5 x^3\right) (a+x)^5
%     &\text{ for } -a<x\leq a \\
%x &\text{ for } x > a
%\end{cases}
%    \approx x H(x)
%\end{align}
%Note that $\Theta_a(0) = 0.5$ and $\theta_a(0) = 35a/256$.
%
We now use the region defined by
\begin{align}\label{eq:wall}
    \chi_w(R,Z,\varphi):=\Theta_{\alpha/2}\left(\psi_{p,b} + \frac{\alpha}{2} - \psi \right) \approx H(\psi_{p,b}-\psi)
\end{align}
to define the wall region.
In order to simplify the setup of this region we give $\psi_{p,b}$ and $\alpha$ in terms of
$\rho_p$ and $\alpha_p$ via $\psi_{p,b} = (1-\rho_{p,b}^2)\psi_{p,O}$ and $\alpha = -(2\rho_{p,b} \alpha_p + \alpha_p^2)\psi_{p,O}$. In case we change the sign
of $\psi_p$ via $\mathcal P_\psi$ (to make it concave) note that $\alpha$ becomes
negative and $\psi_{p,O}$ is positive).
We then need to point mirror Eq.~\eqref{eq:wall} at $\psi_{p,b}+\frac{\alpha}{2}$.

Now, our idea is to dampen the density and velocity in the region defined by the
wall to $N_w$ or $U_{\parallel,w}$ respectively.
For both electrons and ions we add to the equations
\begin{subequations} \label{eq:wall_penalization}
\begin{align}
    \partial_t N &= F_N -\omega_w\chi_w (N-N_w)\\
    \partial_t W_\parallel &= F_U -\omega_w\chi_w (U_\parallel-U_{\parallel,w})
\end{align}
\end{subequations}
where $\omega_w$ is the penalization parameter and $F_N$ and $F_U$ are the
right hand sides as defined in Eqs.~\eqref{eq:EgyrofluidN} and \eqref{eq:EgyrofluidU}.
\begin{minted}[texcomments]{js}
"boundary":
{
    "wall" :
    {
        // Simple flux aligned wall above a threshold value
        "type" : "heaviside",
        "boundary" : 1.2, // wall region boundary $\rho_{p,b}$
        // yields $\psi_0 = (1-\rho_{p,b}^2)\psi_{p,O}$ in Eq.\eqref{eq:wall}.
        "alpha" : 0.25, // Transition width $\alpha_p$: yields
        // $\alpha=-2\rho_{p,b}\alpha_p+\alpha_p^2)\psi_{p,O}$ for the Heaviside
        // in the wall function \eqref{eq:wall}.

        // Double flux aligned wall above and below a threshold value
        "type" : "sol_pfr",
        "boundary" : [1.2, 0.8],
        "alpha" : [0.05,0.05],
        // first one is for main region, second one for PFR

        // sol and pfr for 2 X-points
        "type" : "sol_pfr_2X",
        "boundary" : [1.2, 0.9, 1.1, 0.9],
        "alpha" : [0.05,0.02, 0.05, 0.01],
        // 1. outboard region, 2. 1st X PFR, 3. inboard, 4. 2nd X PFR

        "penalization" : 1.0, //penalization coefficient $\omega_w$ in density
        // and velocity damping Eq.\eqref{eq:wall_penalization}
        "modify-B" : false, // modify the magnetic field inside the wall to a
        // purely toroidal field (uses the same parameters as the wall itself)
        "penalize-rhs" : false, // if true we use Eq.\eqref{eq:wall_equations} else \eqref{eq:wall_penalization}
        "nwall" : 0.1, // $N_w$ (see also nbc, background and minne)
        "uwall" : 0.0 // $U_{\parallel,w}$
    }
}
\end{minted}
\noindent
The last parameter indicates that we penalize the right hand side of our equations
as in
\begin{subequations} \label{eq:wall_equations}
\begin{align}
    \partial_t N &= F_N ( 1-\chi_w) -\omega_w\chi_w (N-N_w)\\
\partial_t W_\parallel &= F_U ( 1 - \chi_w) -\omega_w\chi_w (U_\parallel-U_{\parallel,w})
\end{align}
\end{subequations}
The polarization equation is penalized according to the immersed boundary method
\begin{align}
    -\nc\left( \frac{N_i}{B^2}\np \phi \right) = (\Gamma_{1,i} N_i - n_e)(1-\chi_w)
\end{align}


\begin{tcolorbox}[title=Note]
    Computing on a box and cutting away the parts that are the wall,
    for typical tokamak shapes incurs a (loosely) estimated 50\% overhead in vector size:
    \begin{align*}
        \text{ number of points in box } = 1.5 \times \text{ number of points in area with plasma}
    \end{align*}
\end{tcolorbox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{The sheath region}\label{sec:sheath}
\begin{minted}[texcomments]{js}
"boundary":
{
    "sheath" :
    {
        // no sheath region
        "type" : "none",
    }
}
\end{minted}
In order to define sheath boundary conditions we first define a sheath region
and then determine whether the field lines point toward the wall or away from it.
We define as sheath any part on the bounding box that is not included in the wall
penalization. Then we check for each point in the box the poloidal distance (in
terms of angle $\varphi$) to the sheath wall and if the poloidal field points
toward or away from the wall closest to it.
We then take $\theta_{\alpha/2}\left( 2\pi(\eps_s - \frac{\alpha}{2}) - d(R,Z)\right)$
and take the set intersection of that region and the ``not wall'' region to
determine the sheath penalization region:
\begin{align}\label{eq:sheath}
\chi_s := \left(1-\chi_w(R,Z,\varphi)\right) \theta_{\alpha/2}\left( 2\pi\left(\eps_s - \frac{\alpha}{2}\right) - d(R,Z)\right)
\end{align}
Within the sheath region we penalize
\begin{subequations} \label{eq:sheath_penalization}
\begin{align}
    \partial_t N &= F_N -\omega_s \chi_s \left(N-N_{sh}\right)\\
    \partial_t W &= F_U -\omega_s \chi_s \left(U_\parallel-U_{\parallel,sh}\right)
\end{align}
\end{subequations}
where $\omega_s$ is the sheath penalization parameter.
$N_{sh}$ is obtained by extrapolating $N$ along the magnetic field line with
the help of the parallel derivative operators
\begin{align}
    N_{sh} = \Tpm N \text{ such that } \nabla_\parallel N|_{sh} = 0
\end{align}
where the sign depends again on the direction of the magnetic field line (we always extrapolate ``downstream'').
The extrapolation models a parallel Neumann boundary condition for the density.

The boundary condition for the parallel electron velocity can be either the Bohm condition containing the contribution from the electric potential or
an insulating condition where the total current $j_\parallel =  (N_i U_{\parallel,i} - n_e u_{\parallel,e})$ vanishes.

\begin{align}
    U_{\parallel,i, sh} &= s\sqrt{1+\tau} \\
    u_{\parallel,e, sh} &= s\frac{\sqrt{1+\tau}}{\sqrt{2\pi|\mu_e|}}\exp(-\phi) &\text{ "bohm" } \label{eq:bohm_sheath}\\
    u_{\parallel,e, sh} &= U_{\parallel,i,sh}N_i/n_e &\text{ "insulating" } \label{eq:insulating_sheath} \\
    u_{\parallel,e, sh} &= U_{\parallel,i,sh} = 0 &\text{ "wall" } \label{eq:wall_sheath}
\end{align}
where "s" is a fieldline coordinate that equals $-1$ on the negative divertor and $+1$ on the positive divertor
and varies linearly in-between.
\begin{tcolorbox}[title=Note]
    The sign $+1$ of the divertor is defined such that if we follow $+\bhat$
    then we leave the domain.
    The sign $-1$ of the divertor is defined such that if we follow $-\bhat$
    then we leave the domain.
\end{tcolorbox}
\begin{minted}[texcomments]{js}
"boundary" :
{
    "sheath" :
    {
        "type" : "bohm", // Eq.\eqref{eq:bohm_sheath}
        "type" : "insulating" // Eq.\eqref{eq:insulating_sheath}
        "type" : "wall" // Eq.\eqref{eq:wall_sheath}
        "boundary" : 3/32, // Total width of the sheath $\eps_s$ away from the wall
        // in units of $2\pi$ in Eq.\eqref{eq:sheath}
        "alpha" : 2/32, // Transition width $\alpha$
        // in units of $2\pi$ in Eq.\eqref{eq:sheath}.
        "penalization" : 1.0, //penalization coefficient $\omega_s$ in density
        // and velocity damping Eq.\eqref{eq:sheath_penalization}
        "penalize-rhs" : false // if true we use Eq.\eqref{eq:sheath_equations} else Eq.\eqref{eq:sheath_penalization}
        "coordinate" : "s", // can be "s" or "phi", should be "s"
        "max_angle" : 4 // $\varphi_{\max}$ in units of $2\pi$
        // in order to compute field-line following coordinates
        // we need to integrate fieldlines. In order to avoid infinite integration
        // we here give a maximum angle where to stop integration
    }
}
\end{minted}
\noindent
The last parameter indicates that we penalize the right hand side of our equations
as in
\begin{subequations} \label{eq:sheath_equations}
\begin{align}
    \partial_t N &= F_N ( 1-\chi_s)  -\omega_s\chi_s (N-N_{sh})\\
    \partial_t W_\parallel &= F_U  ( 1 - \chi_s) -\omega_s\chi_s (U_\parallel-
        U_{\parallel,sh})
\end{align}
\end{subequations}
\begin{tcolorbox}[title=Note]
    Make sure that in case the rhs is not penalized the density boundary conditions
    read \texttt{dg::NEU} and the "FCI" boundary condition is set to "along\_field".
    Same for the velocity.
\end{tcolorbox}

\begin{tcolorbox}[title=Note]
    In case both wall and sheath boundaries penalize the equations we get
    \begin{subequations} \label{eq:sheath_wall_equations}
    \begin{align}
        \partial_t N &= F_N ( 1-\chi_s - \chi_w)  -\omega_s\chi_s (N-N_{sh}) -\omega_w\chi_w (N-N_{w})\\
        \partial_t W_\parallel &= F_U  ( 1 - \chi_s- \chi_w) -\omega_s \chi_s (U_\parallel - U_{\parallel,sh})-\omega_w\chi_w (U_\parallel- U_{\parallel,w})
    \end{align}
    \end{subequations}
    In this case the perpendicular boundary
    conditions "bc" for $N$ and $U_\parallel$ and the FCI implementation for the
    boundary for $N$ and $U_\parallel$ become irrelevant.
The polarization equation is penalized according to the immersed boundary method
\begin{align}
    -\nc\left( \frac{N_i}{B^2}\np \phi \right) = (\Gamma_{1,i} N_i - n_e)(1-\chi_w -\chi_s)
\end{align}
\end{tcolorbox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Box boundary conditions}
Here we can set the boundary conditions on the actual box boundary.
This affects the implementation of the elliptic equations and the
perpendicular terms.

The boundary conditions for the potential and the magnetic potential are not
penalized and thus hold on the bounding box. Typically we choose
\begin{align}
\phi = 0
\text{ and }  \hat n \cn A_{\parallel} = 0
\end{align}
where $\hat n$ is the normal vector to the boundary.

\begin{minted}[texcomments]{js}
"boundary":
{
    // must be either DIR or NEU in both directions!!
    "bc" :
    {
        "density" : [NEU, NEU], // boundary conditions in x and y for $n_e$
        // and $N_i$, DIR (density 1 on boundary) means both convective and
        // diffusive outflow while NEU (gradient 0) means no outflow by diffusion
        "nbc" : 1.0, // Dirichlet value; must be present if and only if any one
        // density boundary condition is DIR (see also nwall, background and minne)
        "velocity" : [NEU, NEU], // boundary conditions in x and y for
        // $u_{\parallel,e}$ and $U_{\parallel,i}$,
        // DIR is in general not very stable, NEU works better
        "potential" : [DIR, DIR], // boundary conditions in x and y for $\phi$
        // and $\psi$, DIR means that the $v_{E,\perp}=0$ on the boundary (i.e.
        // no outflow by \ExB drift), NEU can have a detrimental effect on timestep
        "aparallel" : [NEU, NEU] // boundary conditions in x and y for $A_\parallel$,
        // in general should be the same as the velocity bc
    }
}
\end{minted}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Initial conditions} \label{sec:initial}
See the file {\tt init.h} to add your own custom condition.

We have the possibility to
initialize a simulation with the output of a previously
run simulation:
\begin{minted}[texcomments]{js}
"init":
{
    "type" : "restart",
    // only the "file" parameter is needed (also see Section \ref{sec:restart})
    "file" : "path/to/file.nc"
    // the file to use as a restart for $n_e$, $N_i$, $u_{\parallel,e}$ and $U_{\parallel,i}$
}
\end{minted}
In contrast, we can initialize the fields $n_e$, $N_i$, $u_{\parallel,e}$, $U_{\parallel,i}$
directly:
\begin{minted}[texcomments]{js}
"init":
{
    "type" : "fields",
    // "density", "potential", "velocity", "aparallel"
}
\end{minted}
The density can be initialized to the constant background value
\begin{minted}[texcomments]{js}
"init":
{
    "density" :
    {
        "type" : "const"  // $n_e = N_i = const$, $\phi = 0$
        "background" : 0.1, // $const$
        // same as choosing "const" profile with zero ntilde and no damping
        //(see also nbc, minne and nwall)
    }
    //  "potential not needed
}
\end{minted}
Or we initialize the electron density with
\begin{align} \label{eq:initial_ne}
    n_e(R,Z,\varphi, 0)= (n_{prof}(R,Z) + \tilde n(R,Z,\varphi) - n_{bg}) D(R,Z) + n_{bg}
\end{align}
consisting of a toroidally symmetric profile $n_{\text{prof}}(R,Z)$ and a
perturbation $\tilde n(R,Z,\varphi)$, which breaks the toroidal symmetry,
multiplied with a damping profile $D(R,Z)$ (typically with values between 0 and
1) that optionally dampens the density to a constant background value $n_{bg}$.
Each of these functions can be chosen separately using parameters in the input
file.  Note that we should take care to intitialize a smooth profile with
ideally well-defined $\Delta^2_\perp n_e$.

We have three possibilities to initialize the ion density
\begin{align} \label{eq:initphi}
    N_i = n_e \text{ or }N_i = \Gamma_{1,i}^{-1} n_e \text{ or } N_i = \Gamma_{1,i}n_e\approx \left(1+\frac{1}{2}\tau_i\mu_i\Delta_\perp\right)n_e
\end{align}
In the first case the potential $\phi= 0$ while in the second case
the $E\times B$ and ion diamagnetic vorticity coincide $\Delta_\perp N_i \propto \Delta_\perp \phi$ in the long-wavelength limit.
Note that $\alpha$ must not be too small to avoid $N_i < 0$.
\begin{minted}[texcomments]{js}
"init":
{
    "density" :
    {
        "type" : "ne",  // $n_e = n_{bg} + (n_{prof}(R,Z) + \tilde n(R,Z,\varphi) - n_{bg}) D(R,Z)$
        // \ldots ntilde\ref{sec:ntilde}, profile\ref{sec:profile} and damping\ref{sec:damping} parameters
    }
    "potential" :
    {
        "type" : "zero_pol",// $N_i = n_e$ (polarization charge is 0)
        "type" : "zero",    // $N_i = \left( 1 - \frac{1}{2}\tau_i\mu_i\Delta_\perp \right) n_e= \Gamma_{1,i}^{-1} n_e $ (same as zero\_pol if $\tau_i = 0$)
        "type" : "balance", // $N_i = \left(1+\frac{1}{2}\tau_i\mu_i\Delta_\perp\right)n_e\approx \Gamma_{1,i}n_e$ (same as zero\_pol if $\tau_i = 0$)
    }
}
\end{minted}
\noindent
We can also reverse the roles of electron and ion densities like so:
\begin{minted}[texcomments]{js}
"init":
{
    "density" :
    {
        "type" : "ni",  // $N_i = (n_{prof}(R,Z) + \tilde n(R,Z,\varphi) - n_{bg}) D(R,Z) + n_{bg}$
        // \ldots ntilde\ref{sec:ntilde}, profile\ref{sec:profile} and damping\ref{sec:damping} parameters
    }
    "potential" :
    {
        "type" : "zero_pol",// $n_e = N_i$ (polarization charge is 0)
        "type" : "zero",    // $n_e = \Gamma_{1,i}N_i$ (ignored if $\tau_i = 0$)
        "type" : "balance", // $n_e = \left(1-\frac{1}{2}\tau_i\mu_i\Delta_\perp\right)N_i = \Gamma_{1,i}^{-1}N_i$ (ignored if $\tau_i = 0$)
    }
}
\end{minted}
\noindent
The velocity can be chosen zero
\begin{minted}[texcomments]{js}
"init":
{
    "velocity" :
    {
        "type" : "zero",  // $u_{\parallel,e}(R,Z,\varphi,0) = U_{\parallel,i}(R,Z,\varphi,0) = 0$
    }
    // "aparallel" not needed
}
\end{minted}
\noindent
Or we initialize a linear profile between the divertor plates. This is achieved
by integrating fieldlines towards the positive and negative divertor.
\begin{minted}[texcomments]{js}
"init":
{
    "velocity" :
    {
        "type" : "ui",
        "profile" : "linear_cs" // $ U_{\parallel,i}= s\sqrt{1+\tau}$ in the SOL
        // where "s" is the fieldline coordinate defined in section\ref{sec:sheath}
        // if the sheath type is "none" then $s=0$
    }
    "aparallel"
    {
        "type" : "zero", // $u_{\parallel,e} = N_i U_{\parallel,i} / n_e$
    }
}
\end{minted}
\noindent
\subsubsection{Ntilde} \label{sec:ntilde}
We can choose between several initial conditions for $\tilde n$:
\begin{minted}[texcomments]{js}
"density":
{
    "ntilde" : { "type" : "zero" } // $\tilde n = 0$
}
\end{minted}

%\subsubsection{Blob}
We initialize a blob in the R-Z plane
\begin{align} \label{eq:initial_blob}
  \tilde n_{blob}(R,Z,0) = \triangle n \exp\left( -\frac{(R - R_0 - p_x a)^2 + (Z-p_ya)^2}{\sigma^2 a^2} \right)
\end{align}
Then, we use fieldline integration modulated by either
\begin{align} \label{eq:modulation_blob}
    m_{\text{gaussian}}(\varphi) = \exp\left( -\frac{\varphi^2 }{\pi^2\sigma_z^2} \right)
\end{align}
or
\begin{align} \label{eq:modulation_step}
    m_{\text{step}}(\varphi) = \begin{cases}
        1 &\text{for } -\pi\sigma_z < \varphi < \pi \sigma_z \\
        0 & \text{else}
    \end{cases}
\end{align}
to transform this blob to all other poloidal planes.
We either follow fieldlines around the torus several times or only once.
\begin{minted}[texcomments]{js}
"density":
{
    "ntilde" :
    {
        "type" : "blob", // Choose Eq.\eqref{eq:initial_blob}
        "amplitude": 1.0, // $\triangle n$ in Eq.\eqref{eq:initial_blob}
        "posX" : 0, // $p_x$ in Eq.\eqref{eq:initial_blob}
        "posY" : 0, // $p_y$ in Eq.\eqref{eq:initial_blob}
        "sigma" : 1.0, // $\sigma$ in Eq.\eqref{eq:initial_blob}
        "revolutions" : 1, // times the blob is followed around the torus
        "parallel" : "gaussian" // Eq.\eqref{eq:modulation_blob}
        "parallel" : "step" // Eq.\eqref{eq:modulation_step}
        "sigma_z" :  0.5 // $\sigma_z$ in Eq.\eqref{eq:modulation_blob} or \eqref{eq:modulation_step}
    }
}
\end{minted}

%\subsubsection{Turbulent bath}
We can initialize the R-Z plane with a turbulent bath with a certain amplitude $A$.
This especially has the goal to destabilize the edge region right inside the
last closed flux surface. Notice that the core region is rather stable
and quickly damps away fluctuations.
Again, we transform this to all poloidal planes along the magnetic field lines and multiply the bath with
\begin{align} \label{eq:initial_turbulent}
    \tilde n_e(R,Z,\varphi) = \tilde n_{\text{bath}}(R,Z,\varphi)
\end{align}
\begin{minted}[texcomments]{js}
"density":
{
    "ntilde" :
    {
        "type" : "turbulence", // Choose Eq.\eqref{eq:initial_turbulent}
        "amplitude": 1.0, //amplitude of perturbation in Eq.\eqref{eq:initial_turbulent}
        "revolutions" : 1, // times the bath is followed around the torus
        "parallel" : "gaussian" // Eq.\eqref{eq:modulation_blob}
        "parallel" : "step" // Eq.\eqref{eq:modulation_step}
        "sigma_z" :  0.5 // $\sigma_z$ in Eq.\eqref{eq:modulation_blob} or \eqref{eq:modulation_step}
    }
}
\end{minted}
We can initialize the R-Z plane with zonal flows of amplitude $A$ and
wavelength $k_\psi$ aligned with the magnetic flux surfaces.
\begin{align} \label{eq:initial_zonal_flow}
    \tilde n_{\text{zonal}}(R,Z) &= A \sin (2\pi k_\psi \psi_p(R,Z)) \nonumber\\
\tilde n_e(R,Z,\varphi) &= \tilde n_{\text{zonal}}(R,Z)
\end{align}
\begin{minted}[texcomments]{js}
"density":
{
    "ntilde" :
    {
        "type" : "zonal", // Choose Eq.\eqref{eq:initial_zonal_flow}
        "amplitude": 1.0, // $A$ in Eq.\eqref{eq:initial_zonal_flow}
        "k_psi" : 0.5 // $k_\psi$ in Eq.\eqref{eq:initial_zonal_flow}
    }
}
\end{minted}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Profile} \label{sec:profile}
We can have a constant (background) profile
\begin{minted}[texcomments]{js}
"density":
{
    "profile" :
    {
        "type" : "const",// $n_{prof} = const$
        "background" : 0.1 // $const$
        //(see also nbc, minne and nwall)
    }
}
\end{minted}
 \noindent
We define a flux-aligned density profile as
\begin{align} \label{eq:density_profile}
    n_{\text{prof}}(R,Z)= \begin{cases}
        n_{peak}\frac{\psi_p(R,Z) }{\psi_{p,O}} + n_{sep} \frac{\psi_{p,O} - \psi_p(R,Z)}{\psi_{p,O}} &\text{ for } \frac{\psi_p}{\psi_{p,O}} > 0\\
        n_{\text{bg}} + \exp\left( \frac{n_{peak} - n_{sep}}{(n_{sep}-n_{bg})\psi_{p,O}}\psi_p\right) ( n_\text{sep} - n_{\text{bg}})&\text{ else }
    \end{cases}
\end{align}
This profile is linear in $\psi_p$ in the closed fieldline region and exponentially
decreases in the SOL to a constant background value.
The function is once continuously differentiable at $\psi_p =0$.
Typically this profile is used in combination with an aligned damping profile~\eqref{eq:aligned_damping}.
\begin{minted}[texcomments]{js}
"density":
{
    "profile" :
    {
        "type" : "aligned",
        "npeak" : 10.0, // Profile peak density $n_{peak}$ in Eq.\eqref{eq:density_profile}
        "nsep" : 1.0, // Profile separatrix density $n_{sep}$ in Eq.\eqref{eq:density_profile}
        "background" : 0.2 // $n_{bg}$ in Eq.~\eqref{eq:density_profile},
        //also value to which to dampen the profile in Eq.\eqref{eq:initial_ne}
        //(see also nbc, minne and nwall)
    }
}
\end{minted}
\noindent
Instead of the flux-aligned profile we can also choose a toroidally symmetric Gaussian profile
\begin{align} \label{eq:profile_blob}
    n_{prof}(R,Z) = n_{bg} + A \exp\left( -\frac{(R - R_0 - p_x a)^2 + (Z-p_ya)^2}{\sigma^2} \right)
\end{align}
\begin{minted}[texcomments]{js}
"density":
{
    "profile" :
    {
        "type" : "gaussian",
        "background" : 1.0, // $n_{bg}$ in Eq.~\eqref{eq:profile_blob},
        //also value to which to dampen the profile in Eq.\eqref{eq:initial_ne}
        //(see also nbc, minne and nwall)
        "amplitude": 1.0, // $A$ in Eq.\eqref{eq:profile_blob}
        "posX" : 0, // $p_x$ in Eq.\eqref{eq:profile_blob}
        "posY" : 0, // $p_y$ in Eq.\eqref{eq:profile_blob}
        "sigma" : 1.0, // $\sigma$ in Eq.\eqref{eq:profile_blob}
    }
}
\end{minted}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Damping} \label{sec:damping}
We can have no damping
\begin{minted}[texcomments]{js}
"density":
{
    "damping" : { "type" : "none" } // $D(R,Z) = 1$
    //$n_{bg}$ drops from initial condition Eq.\eqref{eq:initial_ne}
}
\end{minted}
\begin{tcolorbox}[title=Recent Update]
You can now choose any type from Section~\ref{sec:wall} here.
The damping is then defined as $D(R,Z) = 1- \chi_w(R,Z)$.
Then the only difference between e.g. type "sol\_pfr" and "aligned" below is
(with same alpha and boundary values) that the
transition between damping and no-damping happens outside, respectively
inside the given boundary parameter.
\end{tcolorbox}

Or we can have an aligned damping profile
\begin{align}
    \label{eq:aligned_damping}
    D_\mathrm{aligned}(R,Z)&=\Theta_{\alpha_p/2}\left(\rho_{p,b}-\rho_p(R, Z)-\frac{\alpha_p}{2}\right)\\
    \label{eq:alignedX_damping}
    D_\mathrm{alignedX}(R,Z)&=\Theta_{\alpha_p/2}\left(\rho_{p,b}-\rho_p(R, Z)-\frac{\alpha_p}{2}\right) H(Z-Z_X)
\end{align}
The second Heaviside is multiplied only if the equilibrium $\psi_p$ has an
X-point and avoids a profile in the private flux region.
The factor $\alpha_p$ provides a smooth transition
zone that avoids numerical oscillations.
\begin{tcolorbox}[title=Note]
    All damping acts on the \textbf{un-modified} magnetic field.
\end{tcolorbox}
\begin{minted}[texcomments]{js}
"density":
{
    "damping" :
    {
        "type" : "aligned", // Choose Eq.\eqref{eq:aligned_damping}
        "type" : "alignedX", // Choose Eq.\eqref{eq:alignedX_damping}
        "alpha" : 0.2,
        // $\alpha_p$ in Eq.\eqref{eq:aligned_damping},
        // (should be small but cannot be too small if $\tau_i > 0$ else
        // $\Delta_\perp n_e$ explodes, must not be zero)
        "boundary" : 1.0    // $\rho_{p,b}$ in Eq.\eqref{eq:aligned_damping}
        //(see also nbc, minne and nwall)
    }
}
\end{minted}
If a profile also in the SOL is desired we can provide a "sol\_pfr" type damping
profile requiring two boundaries and alphas
\begin{minted}[texcomments]{js}
"density":
{
    "damping" :
    {
        "type" : "alignedPFR", // Choose double sided damping region in SOL and PFR
        "alpha" : [0.2, 0.2], //first one is for main region, second one for PFR
        // $\alpha_p$ in Eq.\eqref{eq:aligned_damping},
        // (should be small but cannot be too small if $\tau_i > 0$ else
        // $\Delta_\perp n_e$ explodes, must not be zero)
        "boundary" : [0.7, 1.1],    // $\rho_{p,b}$ in Eq.\eqref{eq:aligned_damping}
        // first one is for main region, second one for PFR
        // second values should be $\alpha+\rho_b \leq 1$
    }
}
\end{minted}
Finally, we can have a circular damping profile
\begin{align} \label{eq:circular_damping}
    D_\mathrm{circular}(R,Z) = \Theta_{ a \alpha_p/2}\left( r a- \sqrt{(R-R_0)^2 + Z^2}\right)
\end{align}
\begin{minted}[texcomments]{js}
"density":
{
    "damping" :
    {
        "type" : "circular", // Choose Eq.\eqref{eq:circular_damping}
        "alpha" : 0.2,      // $\alpha_p$ in Eq.\eqref{eq:circular_damping}, must not be zero
        "boundary" : 1.0    // $r$ in Eq.\eqref{eq:circular_damping}
    }
}
\end{minted}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Sources} \label{sec:sources}
See the file {\tt init.h} to add your own custom source.

The first task of the source is to globally ensure a minimum density. This
is required since through sheath dissipation the density can in
principle become arbitrarily close to zero. This would however
be detrimental to the stability of the simulation and in reality
also never happens due to wall-recycling etc.
\begin{align}
    S_{n_e} = -\omega_{\min} ( n - n_{\min}) \Theta_{\alpha/2}( n_{\min}-\alpha/2 -n)
    \label{eq:minimumne}
\end{align}
\begin{tcolorbox}[title=Note]
    We do not add Eq.~\eqref{eq:minimumne} as a source in the file output or in
    the expression for the velocity source later on.
\end{tcolorbox}
The Heaviside function ensures that this source term only acts when the density
is below the lower limit. $n_{\min}=0$ disables this term.
\begin{minted}[texcomments]{js}
"source":
{
    "minne" : 0.1 // $n_{\min}$ in Eq.\eqref{eq:minimumne}
    //if 0 then the other two parameters are ignored
    "minrate" : 1 // $\omega_{\min}$ in Eq.\eqref{eq:minimumne} (only if $n_{\min}>0$)
    "minalpha" : 0.01 // $\alpha$ in Eq.\eqref{eq:minimumne} (only if $n_{\min}>0$)
}
\end{minted}
\noindent
In order to disable any additional source terms choose
\begin{minted}[texcomments]{js}
"source":
{
    "type" : "zero" // $S_{n_e} = 0$
}
\end{minted}
\noindent We can choose the source terms $S_N$ to force a profile
\begin{align} \label{eq:electron_source}
    S_{n_e}(R,Z,\varphi, t) &= \omega_s (n_{prof}(R,Z) - n_e(R,Z,\varphi, t))D(R,Z)
\end{align}
where $\omega_s$ is the source strength parameter.
The forced source will result in exponential adaption of the core
density profile of the form $n_e \propto n_{prof}+(n_{prof}-n_{e,0})e^{-\omega_st}$.
\begin{minted}[texcomments]{js}
"source":
{
    "type" : "fixed_profile",
    "rate" : 1e-3 // source strength $\omega_s$
    "profile" :
    {
        // Determine $n_{prof}(R,Z)$
        // Choose anything from section\ref{sec:profile}
    },
    "damping" :
    {
        // $D(R,Z)$ determines where the source is active
        // Choose anything from section\ref{sec:damping}
        // The background parameter must be present but is ignored ($n_{bg} = 0$)
    }
}
\end{minted}

Another option is to provide a constant influx of particles
\begin{align}
    S_{n_e}(R,Z,\varphi, t) &= \omega_s \left( (n_{prof}(R,Z) + \tilde n(R,Z,\varphi) - n_{bg})D(R,Z) + n_{bg}\right)
\end{align}
where $\omega_s$ is the source strength parameter.
The idea is that you can start with zero density and evolve the profile purely
with the source. Destabilization of the profile works if you put a turbulent
bath on top of it.
\begin{tcolorbox}[title=Note]
    See the output \mintinline{c}{sne_tt_ifs} in \mintinline{bash}{feltordiag.cu} for how much mass
the source with the parameters below generates and compare to
\mintinline{c}{jsne_tt_fsa} to see how much mass is lost.
\end{tcolorbox}
\begin{minted}[texcomments]{js}
"source":
{
    "type" : "influx",
    "rate" : 1e-3, // source strength $\omega_s$
    "ntilde" :
    {
        // Determine $\tilde n(R,Z,\varphi)$
        // Choose anything from section\ref{sec:ntilde}
        // The turbulent bath works well to destabilize the profile
    },
    "profile" :
    {
        // Determine $n_{prof}(R,Z)$
        // Choose anything from section\ref{sec:profile}
    },
    "damping" :
    {
        // Determine $D(R,Z)$
        // Choose anything from section\ref{sec:damping}
        // The boundary determines where the source is active
    }
}
\end{minted}

We can choose the special ringed Gaussian TCV source of the form
\begin{align}
    S_{n_e}(R,Z) &= \omega_s \exp\left( -\frac{(\psi_p-\psi_{p,0})^2}{\sigma^2}\right)H(Z-Z_X)
\end{align}
with $\psi_{p,0} = \psi_p(1075, -10)$ and $\sigma = 0.0093\psi_{p,0}/0.4$,
\begin{minted}[texcomments]{js}
"source":
{
    "type" : "tcv",
    "rate" : 1e-3 // source strength $\omega_s$
}
\end{minted}
or a Torpex inspired source profile
\begin{align} \label{eq:electron_source_torpex}
  S_{n_e}(R,Z) &= \omega_s
  \begin{cases}
    \exp\left( - \frac{(R-R_0)^2}{a^2 }- \frac{(Z-Z_0)^2}{b^2}\right) \text{ if} R > R_0 \\
    \frac{1}{2}\exp\left( - \frac{(R-R_0)^2}{a^2} -2c(R-R_0)(Z-Z_0)- \frac{(Z-Z_0)^2}{b^2} \right) \\
  +\frac{1}{2}\exp\left( - \frac{(R-R_0)^2}{a^2} +2c(R-R_0)(Z-Z_0)- \frac{(Z-Z_0)^2}{b^2} \right) \text{ else}
  \end{cases}
\end{align}
with $a=0.0335$m, $b=0.05$m, $c=565m^{-2}$, $R_0=0.98$m and $Z_0=-0.02$m.
\begin{minted}[texcomments]{js}
"source":
{
    "type" : "torpex",
    "rate" : 1e-3 // source strength $\omega_s$
}
\end{minted}

In order to not generate potential with the source term the
ion source needs to fulfill $S_{n_e} = \Gamma_{1,i}S_{N_i} + \nc\left( \frac{\mu_i S_{N_i}}{B^2}\np \phi\right)$ which in the long wavelength limit can be inverted to (the long wavelength limit should be well-fulfilled for a realistic source term since the amplitude is typically quite small)
\begin{align}
    S_{N_i} = \left(1-\frac{1}{2}\mu_i \tau_i \Delta_\perp\right) S_{n_e} -\nc\left( \frac{\mu_i S_{n_e}}{B^2}\np \phi\right)
  \label{eq:ion_source}
\end{align}
Note that the additional terms besides $S_{n_e}$ are total divergences which means
they do not change the volume integrated "total" particle number created by the source.
Note that $S_{n_e}$ needs to be smooth
so that $\np^2 S_{n_e}$ is well defined.
Also note that with our definition of $\Lambda_{n_e}$ and $\Lambda_{N_i}$ and
the polarisation equation we have $\Lambda_{n_e} = \Gamma_{1,i}\Lambda_{N_i} + \nc\left( \frac{\mu_i \Lambda_{N_i}}{B^2}\np \phi\right)$ in the long wavelength limit (swap the operators).
This means that diffusion does not generate potential either.

The velocity source is chosen such that the density source does not introduce
net momentum
\begin{align}
    S_U = -\frac{U_\parallel}{N} S_N
    \label{eq:velocity_source}
\end{align}
for both electrons and ions.

\subsection{Advection}
We implemented an upwind-advection scheme for the perpendicular terms.
No other scheme is currently choosable.

For the parallel advection we implemented a velocity-staggered finite-volume
scheme. Here, we have some choices regarding the slope-limiter to use
\begin{minted}[texcomments]{js}
"advection":
{
    "slope-limiter" : "none", // no slope-limiter
    "slope-limiter" : "minmod", // minmod has the highest dissipation
    "slope-limiter" : "vanLeer", // an average slope-limiter
}
\end{minted}
\begin{tcolorbox}[title=Note]
    A slope limiter increases the discretization order from 1 to 2.
\end{tcolorbox}
\subsection{Regularization} \label{sec:regularization}
In order to stabilize the advection schemes and/or remove cascading energy
from small scale wave components
we implement an artificial viscosity of order $s$ Eq.~\eqref{eq:perpdiffNU}
for the perpendicular terms.
The finite volume scheme is shock capturing and thus does not need
parallel viscosity in the density equations.
The velocity equations already have a high physical
viscosity and thus should not need additional damping.
\begin{tcolorbox}[title=Note]
    We apply the viscosity to the parallel velocities $U_\parallel$ and
    not to the parallel canonical velocities $W_\parallel$.
\end{tcolorbox}
\begin{minted}[texcomments]{js}
"regularization",
{
    "order" : 2,  // order of the artifical diffusion
    "direction" : "centered",  // The direction of the Laplacian
    "nu_perp_n" : 1e-6, // The strength of the diffusion for density
    "nu_perp_u" : 1e-6 // The strength of the diffusion for velocity
    // increase this or the resolution if you see vertical or horizontal
    // oscillations in your simulation box, decrease if simulation
    // looks "out of focus"
}
\end{minted}
Simply set the diffusion to 0 if you do not want any regularization.
\begin{tcolorbox}[title=Note]
    Having to make the timestep smaller due to viscosity
    is a clear warning that \mintinline{c}{nu_perp} is too large for the
    chosen resolution.
\end{tcolorbox}

\subsection{Elliptic solvers}
We discretize all elliptic operators with a local dG method (LDG).  In order to
solve the elliptic equations we chose a multigrid scheme (nested iterations in
combination with conjugate gradient solves on each plane). The accuaracies for
the polarization equation can be chosen for each stage separately, while for
the Helmholtz type equations (The gamma operators and the Ampere equation) only
one accuracy can be set:
\begin{minted}[texcomments]{js}
"elliptic":
{
    "stages"    : 4,  // Number of stages
    // (3 is a good start but 4 or better 5 are beneficial)
    // $2^{\text{stages-1}}$ has to evenly divide both $N_x$ and $N_y$!
    // To tune, observe the number of iterations at each stage in the output file.
    // If the number at the lowest stage is unreasonably high (800 say),
    // then add another stage!
    "eps_pol"   : [1e-6,0.5,0.5,0.5],
    // The first number is the tolerance for the residual of the inversion of the
    // polarisation equation on the finest grid. The second number is a multiplicative
    // factor for the accuracy on the second grid in a multigrid scheme, the
    // third for the third grid and so on:
    // $\eps_0 = \eps_{pol,0}$, $\eps_i = \eps_{pol,i} \eps_{pol,0}$  for $i>1$.
    // Tuning those factors is a major performance tuning oppourtunity!!
    // If the number of iterations at the finest grid is too high then reduce
    // the factor on the coarse grids.
    // For saturated turbulence the suggested values are [1e-6, 0.5, 0.5,0.5].
    "eps_gamma" : 1e-8, // Accuracy requirement of Gamma operator
    "eps_ampere": 1e-8,  //Accuracy requirement of Ampere equation
    "direction" : "forward", // Direction of the Laplacian: forward or centered
    "jumpfactor" : 1.0
    // Jumpfactor $\in \left[0.01,1\right]$ in the local DG method for the
    // elliptic terms in polarization equation.
    //(Don't touch unless you know what you're doing.
}
\end{minted}
\begin{tcolorbox}[title=Note]
    We use solutions from previous time steps to extrapolate an initial guess
    and use $1/\chi$ as a diagonal preconditioner
\end{tcolorbox}
\subsection{FCI: Parallel derivatives}
We discretize all parallel derivatives with the
flux coordinate independent scheme (FCI) adapted to dG methods
cf.~\cite{Held2016,Stegmeir2017}
and use a support operator method.
\begin{minted}[texcomments]{js}
"FCI",
{
    "refine" : [2,2],
    // refinement factor in support operator in R- and Z- direction
    // values higher than [1,1] take longer to solve, but possibly stabilize
    // the simulation
    "rk4eps" : 1e-6, //Accuracy of fieldline integrator. The default is reasonable
    "interpolation-method" : "dg", // "dg" uses default dG interpolation, "linear"
    // uses linear interpolation and "cubic" uses cubic interpolation
    "periodify" : true
    // Indicate if flux function is periodified beyond grid boundaries such that
    // the contours are perpendicular to the boundaries. This is not entirely
    // consistent but works well for small Nz
    // Does not have an effect on derivatives for the "along\_field" mode
    // (but has an effect on field-aligning init and source)

    "bc" : "along_field", // use along\_field function for parallel
    // derivatives, only valid if boundary conditions for density, potential and
    // parallel velocity are each either "dg::DIR" or "dg::NEU" in both directions
    "bc" : "perp", // use perpendicular interpolation technique to implement
    // boundary conditions
}
\end{minted}

\begin{tcolorbox}[title=Note]
The "along\_field" option saves memory because then we can use
the same FCI object for all quantities.
\end{tcolorbox}
\begin{tcolorbox}[title=Note]
    When the "modify-B" option is used for the wall the magnetic fieldlines
    do not intersect the domain boundary in the wall region (but still do in the
    sheath region).
\end{tcolorbox}
\begin{tcolorbox}[title=Note]
The boundary conditions in the FCI scheme are the number one reason of why
simulations crash. See also~\ref{sec:troubleshooting}
\end{tcolorbox}

% Check periodify field

\subsection{Parameters in equations} \label{sec:physical}
\begin{minted}[texcomments]{js}
"physical":
{
    "mu" : -2.72121e-4, // $\mu_e =-m_e/m_i$.
    // One of $\left\{ -5.44617\cdot 10^{-4}, -2.72121\cdot 10^{-4}, -1.81372\cdot 10^{-4} \right\}$
    "tau" : 1.0, // $\tau_i = T_i/T_e$
    "beta" : 5e-5, // Plasma beta $5\cdot 10^{-6}$ (TJK), $4\cdot 10^{-3}$ (Compass),
    // If $0$, then the model is electrostatic
    "resistivity" : 1e-4, // parallel resistivity parameter Eq.\eqref{eq:resistivity}
    "epsilon_D" : 1e-5, // [IGNORED] Eq.\eqref{eq:epsilon_D} This parameter is
    // ignored by all codes, its sole purpose is to make the set of numerical
    // parameters uniquely invertible for analysis purposes (see discussion below)
    "viscosity" : "braginskii", //use Eq.\eqref{eq:nu_parallele} and \eqref{eq:nu_paralleli} for the parallel viscosity

    // use the nu\_parallel field to determine value
    // same for electrons and ions
    "viscosity" : "value",
    "nu_parallel" : [400,400] // first for electrons, second for ions
}
\end{minted}
These parameters, together with the $R_0$ parameter in the magnetic field,
determine the physical parameter regime we are in.
In total, our model has \textbf{5} independent dimensionless parameters
\begin{align*}
    \mu_e = -\frac{m_e}{m_i}\ \tau_i = \frac{T_e}{T_i}\ \beta =
    \frac{n_0T_{e}}{B_0^2/\mu_0}\ \eta_\parallel = \frac{\sqrt{2m_e} e^3 \ln
    \Lambda} {12\pi^{3/2} \epsilon_0^2} \frac{n_0} {B_0T_e^{3/2}} \ R_0
    = \frac{\hat R_0 e B_0}{\sqrt{T_{e}m_i}}
\end{align*}
These are computed from \textbf{6} physical parameters
\begin{align*}
    m_i\ T_e\ T_i\ n_0\ B_0\ \hat R_0
\end{align*}
 A given set of numerical parameters thus represents a one-dimensional
 submanifold of physical parameters.
 This is because we neglect the Debye length relative to the ion gyro-radius
 in the model
 \begin{align}\label{eq:epsilon_D}
     \epsilon_D = (\lambda_D/\rho_s)^2 = \epsilon_0 T_e /n_0 /e^2 / T_e/m_i e^2 B_0^2 = \epsilon_0 B_0^2/n_0 /m_i \rightarrow 0
 \end{align}
If we further neglect $\beta=0$ this becomes a two-dimensional submanifold
of physical parameters.
\begin{tcolorbox}[title=Note]
    In order to invert the system (for given numerical parameters find the
    corresponding physical parameters) we have to (i) give $\epsilon_D$ in the
    input file or (ii) fix one (or more) physical
    parameters to get a solvable system.  In practice this may be the scale of
    the machine $\hat R_0$ (and after that the magnetic field strength $B_0$).
\end{tcolorbox}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Timestepper}
The first option for the time stepper is an explicit fixed-stepsize multistep method
where you can chose the tableau to use
\begin{minted}[texcomments]{js}
"timestepper" :
{
    "type"    : "multistep", //Choose an explicit multistep method
    "tableau" : "TVB-3-3", // Any explicit multistep tableau *
    "dt"      : 2e-2, // Fixed timestep in units of $c_s/\rho_s$
}
\end{minted}
*See the \href{https://feltor-dev.github.io/doc/dg/html/structdg_1_1_explicit_multistep.html}{dg documentation} for what tableaus are available.

The second option is an adaptive explicit embedded Runge-Kutta scheme
\begin{minted}[texcomments]{js}
"timestepper":
{
    "type"    : "adaptive", //Choose an explicit adaptive RK scheme
    "tableau" : "Bogacki-Shampine-4-2-3", // Any explicit embedded RK tableau *
    "rtol"    : 1e-5, // The relative tolerance in the timestep
    "atol"    : 1e-6, // The absolute tolerance in the timestep
    "reject-limit" : 2 // factor over tolarance by which a timestep is rejected
    // if the timestepper fails very often you might want to increase this limit
}
\end{minted}
*See the \href{https://feltor-dev.github.io/doc/dg/html/structdg_1_1_e_r_k_step.html}{dg documentation} for what tableaus are available.

\begin{tcolorbox}[title=Note]
The explicit resistive term leads to an absolute (CFL) restriction
on the timestep according to $\partial_t u_e \propto \frac{\eta}{\mu_e} u_e \Rightarrow \Delta t < \frac{-\mu_e}{\eta}$. This is a quite weak restriction unless the resistivity exceeds $\eta > 10^{-4}$.
The explicit parallel electron viscosity term leads to a CFL condition of the
form $\Delta t < (2\pi (R_0 - a))^2/(N_z^2 \nu_{\parallel,e})$.
\end{tcolorbox}


There are two options on how to compute the time-interval between major file-outputs,
either give the interval directly
\begin{minted}[texcomments]{js}
"timestepper":
{
    "output-mode" : "deltaT",
    "deltaT" : 1 // give the time between major outputs
    //(for a multistep scheme "dt" must divide "deltaT")
}
\end{minted}
The second option is to provide an end-time $T_{\text{end}}$
until which the simulation runs. The output interval is then determined by the "maxout" parameter in the "output" field.
\begin{minted}[texcomments]{js}
"timestepper":
{
    "output-mode" : "Tend",
    "Tend" : 1 // give an absolute end time where the simulation ends
    //(for a multistep scheme "dt" must divide "Tend"/"maxout")
}
\end{minted}

% In every iteration of the implicit inversion we need to solve an equation of the form
% \begin{align}
%     n_e + a \hat L_{n_e} n_e = \hat n_e \\
%     N_i + a \hat L_{N_e} N_i = \hat N_i \\
%     w_e + a \hat L_{u_e} u_e = \hat w_e \\
%     W_i + a \hat L_{U_i} U_i = \hat W_i
% \end{align}
% for given right hand side and unkown $n_e$, $N_i$, $w_e$ and $W_i$ with $W_\parallel=U_\parallel+A_\parallel/\mu$ and $-\Delta_\perp A_\parallel = \beta (N_i U_i -n_e u_e)$ and $\hat L$ the linear implicit part of the equations.
% We solve the system by first isolating and solving the two density equations for $n_e$ and $N_i$. These can then be inserted into the Ampere equation as
% fixed solutions, which makes this equation linear in the velocities.
% We solve the velocity equations by artificially introducing $A_\parallel$ as
% an additional unkown
% \begin{align}
%     \begin{pmatrix}
%         1  + a\hat L_{u_e} & 0 & \frac{1}{\mu_e} \\
%         0 & 1  + a \hat L_{U_i} &  \frac{1}{\mu_i} \\
%     n_e & -N_i &  -\frac{1}{\beta}\Delta_\perp \\
%     \end{pmatrix}
%     \begin{pmatrix}
%         u_e\\ U_i \\ A_\parallel
%     \end{pmatrix}
%     =
%     \begin{pmatrix}
%         \hat w_e\\ \hat W_i \\ 0
%     \end{pmatrix}
% \end{align}
%We can show that $\det M  > 0$ and thus $M$ is invertible.
% We can make the matrix equation symmetric
% \begin{align}
%     \begin{pmatrix}
%     -\mu_e n_e  - a\mu_e n_e \hat L_{u_e} & 0 & -n_e \\
%     0 & \mu_i N_i  + a\mu_i N_i \hat L_{U_i} &  N_i \\
%     -n_e & N_i &  \frac{1}{\beta}\Delta_\perp \\
%     \end{pmatrix}
%     \begin{pmatrix}
%         u_e\\ U_i \\ A_\parallel
%     \end{pmatrix}
%     =
%     \begin{pmatrix}
%         -\mu_e n_e \hat w_e\\ \mu_i N_i \hat W_i \\ 0
%     \end{pmatrix}
% \end{align}
% If both $\hat L$ are symmetric positive definite, this matrix $M'$ is symmetric but unfortunately in-definite
% (insert $(0,0,A_\parallel)$ to get $\vec z^T M' \vec z < 0$ but
% $(u_e, U_i, 0)$ yields $\vec z^T M' \vec z > 0$)
%   and thus cannot be solved via a conjugate gradient solve.
%
%Since the CG cannot be used it is also worth considering an iteration on $w_e$
%and $W_i$
% \begin{align}
%     \begin{pmatrix}
%         1  + a\hat L_{u_e} & 0 & -\frac{1}{\mu_e}a\hat L_{u_e} \\
%         0 & 1  + a \hat L_{U_i} &  -\frac{1}{\mu_i}a \hat L_{U_i} \\
%         \beta n_e & -\beta N_i &  - \frac{\beta}{\mu_e}n_e + \frac{\beta}{\mu_i}N_i -\Delta_\perp \\
%     \end{pmatrix}
%     \begin{pmatrix}
%         w_e\\ W_i \\ A_\parallel
%     \end{pmatrix}
%     =
%     \begin{pmatrix}
%         \hat w_e\\ \hat W_i \\ 0
%     \end{pmatrix}
% \end{align}
% which may be better conditioned because it becomes diagonally dominant for
% small $a$ and large $\beta$.
%%MW: unfortunately even though the idea is to decouple the outer and inner inversions, this does not really work

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Steering the file output} \label{sec:output}
The netcdf/glfw outputs happen at equidistant time-intervals
\begin{align}
    \Delta T_\text{out} = \text{either given by "deltaT" or } \frac{T_{\text{end}}}{m_{\max}}
\end{align}
where $m_{\max}$ stands for the "maxout" parameter in the "output" field.

There is a second time-interval
\begin{align}
    \Delta T_\text{int} &= \frac{\Delta T_\text{out} }{ s_\text{itstp}}
\end{align}
The integration time $\Delta T_\text{int}$ determines how often the diagnostics integration is updated
while the output time $\Delta T_\text{out}$ determines how often 2d/3d fields are written to file.
\begin{tcolorbox}[title=Note]
    The timesteppers do not necessarily exactly match
    $\Delta T_\text{int}$ but they will match $\Delta T_\text{out}$.
\end{tcolorbox}
\begin{minted}[texcomments]{js}
"output":
{
    // Use glfw to display results in a window while computing (requires to
    // compile with the glfw3 library)
    "type" : "glfw",
    "window" : // ONLY GLFW : output window parameters
    {
        "rows":6,        // ONLY GLFW : # of rows
        "reduction" : 4, // ONLY GLFW : # of cols = Nz/reduction+1
        "width" :200,    // ONLY GLFW : box width (in pixel)
        "height" : 200,  // ONLY GLFW : box height (in pixel)
    }
    // Use netcdf to write results into a file (filename given on command line)
    // (see section\ref{sec:output_file} for information about what is written in there)
    "type" : "netcdf",
    "itstp"  : 4, // $s_\text{itstp}$ the number of discretization steps
    // between file outputs (2d and 3d quantities);
    // Flux-surface averages of all quantities can be computed based on full-resolution fields
    // during the simulation (in contrast to feltordiag, which computes them based on the
    // compressed fields which may introduce errors, s.a. Diagnostics):
    "maxout" : 100 // Total Number of fields outputs excluding first
    // If you want to let the simulation run for a long time
    // choose this parameter very large and either manually kill the simulation
    // or let the simulation hit the time-limit (on a cluster for example).
    // ONLY NETCDF
    "compression" : [2,2] // Compress output file by reducing points in x and y
    // (pojecting the polynomials onto a coarser grid): output contains
    // n*Nx/c[0] points in x, (has to divde Nx evenly), and n*Ny/c[1] points in
    // y, (has to divde Ny evenly). 2 or 3 are reasonable values.
    // ONLY NETCDF
}
\end{minted}
\begin{tcolorbox}[title=Note]
    The multistep method uses one function evaluation per time-step while the
    adaptive method uses several. This means that the itstp variable can
    be chosen larger for the adaptive method than for the multistep method.
\end{tcolorbox}


\subsection{[Optional] Output equations flags}\label{sec:output_flags}
The optional variable "equations" contains a list of strings that
determine which variables will be written into the output file.
Each string
corresponds to a different equation that can be studied with FELTOR at the
moment. These equations are described in section \ref{sec:output}, and their
definitions are in the equations titles.
\begin{minted}[texcomments]{js}
"output":
{
    "equations" :
    [
        "Basic",
        "Mass-conserv",
        "Energy-theorem",
        "Toroidal-momentum",
        "Parallel-momentum",
        "Zonal-Flow-Energy",
        "COCE"
    ]
}
\end{minted}
\begin{tcolorbox}[title=Note]
    If the "equations" field does not exist, the default selection is ["Basic", "Mass-conserv", "Energy-theorem","Toroidal-momemtum","Parallel-momentum","Zonal-Flow-Energy"]
\end{tcolorbox}

\subsection{[Optional] Probes (synthetic diagnostics)}
FELTOR has the possibility of getting the output of the computational fields
($n_e$, $N_i$, $u_{\parallel,e}$, $U_{\parallel,i}$, $\phi$ and $A_\parallel$)
including their first derivatives $\partial_R$, $\partial_Z$, $\npar$) in time
interpolated to any grid location (as if a measurement was done at that
location). The output interval is defined at the integration time intervals
$\Delta T_{int}$. The output is described in Section~\ref{sec:probes-output}.

In the input file, it is required to define the R, Z and phi position "R", "Z"
and "P" arrays, for each of the probes included. The R and Z values are
given in $\rho_s$ units, while the toroidal angle is given in radian. The
user should make certain that the length of the position arrays match each
other.
There is no limit on the size of the arrays; they are typically not performance
relevant unless the size exceeds $10^5$.
\begin{minted}[texcomments]{js}
"probes":
{
    "input" : "coords",
    "coords" :
    {
        "format" : format, // see paragraph below
        "coords-names" : ["R","Z","P"], // name of coordinates in order they are passed to interpolation function
        "R": [90, 95, 100], // R coordinates in rho\_s
        "Z": [0, 0, 0], // Z coordinates in rho\_s
        "P": [0, 0, 3] // phi coordinates in radian (values outside the interval
        // $[0,2\pi]$ will be taken modulo $2\pi$ (unsigned))
    }
}
\end{minted}
\begin{tcolorbox}[title=Note]
 If the user does not want to use any probes, the entire "probes" input field
 can be left away. No probes will be written into the output file then.  Be
 sure not to have any spelling mistakes on "probes" if you do want them though.
\end{tcolorbox}
Alternatively the "R", "Z" and "P" fields can be read from an external json file
\begin{minted}[texcomments]{js}
"probes":
{
    "input" : "file",
    "file" : "path/to/probes.json" // relative to folder from where feltor is executed
    "scale" : [1000, 1000, 1] // scale factors for "R", "Z", "P"
}
\end{minted}
\begin{tcolorbox}[title=Units of $R$ and $Z$]
Similar to the magnetic parameters, in this case the "R" and "Z" values can be unnormalized.
The "scale" values are multipled to "R", "Z" and "P" when they are read from file
\end{tcolorbox}
\paragraph{format}
All measurements from points, lines, surfaces and volumes with different
purposes and different diagnostics, must be concatenated and flattened into the
one-dimensional "R", "Z", "P" arrays and the measurements are written to file
as one-dimensional arrays.  In this way the book-keeping "which point belong
to which diagnostics and is neighbor to which other point" may become
challening. This is why the "format" field exists.

The format value is a user-defined json value that is ignored by feltor and
copied "as-is" as a string attribute to the probes group in the output file.
Its purpose is to hold parsing information for the (flat) $R$, $Z$, $P$ arrays
for post-processing. For example
\begin{minted}[texcomments]{js}
"format" : [
{"name" : "x-probe", "pos" : [0,10], "shape" : [10]},
{"name" : "omp", "pos" : [10,1010], "shape" : [10,10,10]}
]
\end{minted}
interprets the first ten points in the probes array as a linear "x-probe" line,
while the remaining 1000 points belong to a 3d measurement volume called "omp".
From this information e.g. array views can be easily created in python:
\begin{minted}[texcomments]{py}
named_arr = dict()
for f in format:
    named_arr[f["name"]] = arr[f["pos"][0]:f["pos"][1]].reshape( f["shape"])
\end{minted}

\subsection{[Optional] Computational flags}
We can simplify the full simulation in a few ways:
\begin{minted}[texcomments]{js}
"flags": [
    "symmetric", // assume toroidal symmetry, in this mode the
    // equations become 2 dimensional and the third dimension in the init
    // condition is ignored, the Nz parameter in the grid is used to initialize
    // the FCI method and then overwritten to $N_z\equiv 1$.
    "calibrate", // Simulation stops after initialization,
    // no right hand side calls
    // not possible for glfw output
    "modify-diff", // see text below
    "no-diff-penalization" //Perp Diffusion is not penalized
]
\end{minted}
You can combine the flags in any way you want: you can have 1 or more
flags present or leave the field empty.
\begin{tcolorbox}[title=Note]
    Use ["symmetric", "calibrate"] together (to avoid FCI initialization
    which takes a long time) and quickly fine-tune
    magnetic field, wall, sheath, init, source and grid parameters
\end{tcolorbox}
If the  "modify-diff" parameter is set to true, the parallel and perpendicular
momentum diffusion parameters $\nu_{U,\perp}$ and $\nu_\parallel$ are
multiplied by density $N$. This means they must appear inside the
divergence, e.g. $\npar^\dagger (\nu_{\parallel} \npar U_\parallel)$.
The hope is that with this modification the minne parameter can be set
to lower values without the small densities affecting the CFL condition.
By default this does not happen.

For the "no-diff-penalization" the idea is to at the same time set
the "wall": "penalization" parameter to $0$ such that a semblance of
Neumann boundary conditions result for the wall.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Restarting} \label{sec:restart}
We have the possibility to initialize time and
the fields with the results of a previous simulation.
There are two possibilities to restart a simulation
\begin{enumerate}
    \item setting the option "restart" in the input file in the init type field
        and providing the path to an \mintinline{bash}{initial.nc} netcdf file in the
        corresponding file field (see Section~\ref{sec:initial})
    \item providing an additional netcdf file \mintinline{bash}{initial.nc}
        to \mintinline{bash}{feltor}, \mintinline{bash}{feltor_hpc} or \mintinline{bash}{feltor_mpi} on the
        command line. This mode takes precedence over the first because it
        subsequently ignores the "init" field of the input file.
\end{enumerate}
The intention behind the two different modes is that there are two different
restarting scenarios. In the first you have one input file that you just want
to restart over and over again. In a way you only want to split a single
simulation into several smaller parts. In the second you want to use a
simulation that ran with a specific set of parameters as an initial condition
for another simulation with different parameters.
\begin{tcolorbox}[title=Note]
    The restart file is only used to initialize $n_e$, $N_i$, $u_{\parallel,e}$
    and $U_{\parallel,i}$ with the latest timestep in \mintinline{bash}{initial.nc}, all
    other parameters (magnetic field, profiles, resolutions, sources, etc.)
    are still read from the input json file.  The user is responsible
    that these are consistent with the paramters in the existing
    \mintinline{bash}{initial.nc} file.
\end{tcolorbox}

\begin{tcolorbox}[title=Note]
    You can submit chain jobs on the cluster. See the --dependency option in SLURM.
\end{tcolorbox}
\begin{tcolorbox}[title=Note]
In order to enable a
loss-less continuation of the simulation we output special restart fields into
the output file that in contrast to the other fields are not compressed.
\end{tcolorbox}


\begin{tcolorbox}[title=Note]
We try to discourage
appending new results to an exisiting file directly, because if for some reason
the cluster crashes and the file is corrupted the whole simulation is lost.
It is safer to just merge files afterwards with
\mint{bash}{ncrcat output1.nc output2.nc output.nc}
from the \mintinline{bash}{nco} package
\end{tcolorbox}

\section{Output} \label{sec:output_file}
Output file format: \href{https://www.unidata.ucar.edu/software/netcdf/docs/}{netcdf-4/hdf5};

A \textit{coordinate variable (Coord. Var.)} is a Dataset with the same name as a dimension.
We follow
\href{http://cfconventions.org/Data/cf-conventions/cf-conventions-1.7/cf-conventions.html}{CF Conventions CF-1.7}
and write according attributes into the file.

\begin{tcolorbox}[title=Note]
    The command \mintinline{bash}{ncdump -h output.nc} gives a full list of what a file contains.
\end{tcolorbox}
Here, we list the content without attributes
since the internal netcdf information does not display equations.
%
%Name | Type | Dimensionality | Description
%---|---|---|---|
\begin{longtable}{lll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Dimension} & \textbf{Description}  \\ \midrule
inputfile  &     text attribute & - & verbose input file as a string (valid JSON, C-style comments are allowed but discarded) \\
x                & Coord. Var. & 1 (x) & $R$-coordinate (computational space, compressed size: $nN_x/c_x$)\\
y                & Coord. Var. & 1 (y) & $Z$-coordinate (computational space, compressed size: $nN_y/c_y$)\\
z                & Coord. Var. & 1 (z) & $\varphi$-coordinate (computational space, size: $N_z$) \\
time             & Coord. Var. & 1 (time)& time at which fields are written (variable size: maxout$+1$, dimension size: unlimited) \\
xc           & Dataset & 3 (z,y,x) & Cartesian x-coordinate $x=R\sin(\varphi)$ \\
yc           & Dataset & 3 (z,y,x) & Cartesian y-coordinate $y=R\cos(\varphi)$\\
zc           & Dataset & 3 (z,y,x) & Cartesian z-coordinate $z=Z$ \\
Psip             & Dataset & 3 (z,y,x) & Flux function $\psi_p(R,Z)$ \\
vol3d            & Dataset & 3 (z,y,x) & Volume form in 3d including dG weights (can be used to integrate 3d quantities)  \\
Nprof            & Dataset & 3 (z,y,x) & Density profile $n_\text{prof}$ used in the forcing source \\
Source           & Dataset & 3 (z,y,x) & Source profile $S_{prof}$\\
BR               & Dataset & 3 (z,y,x) & Contravariant magnetic field component $B^R$ \\
BZ               & Dataset & 3 (z,y,x) & Contravariant magnetic field component $B^Z$ \\
BP               & Dataset & 3 (z,y,x) & Contravariant magnetic field component $B^\varphi$ \\
electrons        & Dataset & 4 (time, z, y, x) & electron density $n_e$ \\
ions             & Dataset & 4 (time, z, y, x) & ion density $N_i$ \\
Ue               & Dataset & 4 (time, z, y, x) & electron velocity $u_{\parallel,e}$ \\
Ui               & Dataset & 4 (time, z, y, x) & ion velocity $U_{\parallel,i}$ \\
potential        & Dataset & 4 (time, z, y, x) & electric potential $\phi$ \\
aparallel        & Dataset & 4 (time, z, y, x) & parallel vector potential $A_\parallel$ \\
X\_2d            & Dataset & 3 (time,y,x) & Selected plane $X(\varphi=0)$ \\
X\_ta2d          & Dataset & 3 (time,y,x) & Toroidal average $\PA{ X }$
Eq.~\eqref{eq:phi_average} \\
Y\_tt\_2d        & Dataset & 3 (time,y,x) & Time integrated (between two outputs, Simpson's rule) selected plane
$\int_{t_0}^{t_1}\d t Y(\varphi=0) $
where $t_1 - t_0 = \Delta T_{\text{out}}$, $t_1$ is the current time and $t_0$ is the time of the last output. \color{red} The first output at time $t_1=0$ is the same as X\_2d !!\color{black} \\
Y\_tt\_ta2d      & Dataset & 3 (time,y,x) & Time integrated (between two outputs, Simpson's rule) toroidal average (Eq.~\eqref{eq:phi_average})
$\int_{t_0}^{t_1}\d t \PA{ Y }$
where $t_1 - t_0 = \Delta T_{\text{out}}$, $t_1$ is the current time and $t_0$ is the time of the last output. \color{red} The first output at time $t_1 = 0$ is the same as X\_2d !!\color{black} \\
\bottomrule
\end{longtable}
where
X and Y\_tt represent the quantities described in the tables in this section starting with the quantities
\begin{longtable}{llll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation} & \textbf{Name} &  \textbf{Equation}\\
\midrule
    electrons &$n_e$ &
    ions &$N_i$ \\
    Ue &$u_{\parallel,e}$ &
    Ui &$U_{\parallel,i}$ \\
    potential &$\phi$ &
    psi &$\psi$ \\
    aparallel &$A_\parallel$ & \\
    gammaNi & $\Gamma_{1,i} N_i$  &
    gammaPhi & $\Gamma_{1,i} \phi$  \\
    vorticity &$-\Delta_\perp\phi$ &
    vorticity\_i & $-\Delta_\perp \psi$ \\
    laplace\_ne &$\Delta_\perp n_e$ &
    laplace\_ni & $\Delta_\perp N_i$ \\
     & &
    apar\_vorticity &$-\Delta_\perp A_\parallel$ \\
    dssue & $\npar^2 u_{\parallel,e}$&
    %dppue & $\partial_\varphi^2 u_{\parallel,e}$\\
    %dpue2 & $(\partial_\varphi u_{\parallel,e})^2$&
    lperpinv &$L_\perp^{-1} := |\vec\np n_e|/n_e$ \\
    perpaligned &$(\vec\np n_e)^2/n_e$ &
    lparallelinv &$L_\parallel^{-1} := |\npar n_e|/n_e$ \\
    aligned &$ (\npar n_e)^2/n_e$ &
    ne2 & $n_e^2$ \\
    phi2 & $\phi^2$ &
    nephi & $n_e\phi$ \\
\bottomrule
\end{longtable}
The computation time spent on diagnostics is usually negligible unless {\tt itstp}
is unreasonably high. Also remember that the X and Y fields are all
two-dimensional, which takes up much less disk-space than three-dimensional
fields. This outputs are saved if the flag "output":"equations":"Basic" is true.

%\subsection{Conservation laws} \label{sec:conservation}
%In the output file we have
\subsection{Mass conservation, "Mass-conserv"}
The density equations directly yield the particle conservation
\begin{align} \label{eq:mass_theorem}
  \frac{\partial}{\partial t} N
  + \nc\vec{ j_{N}}
  =  \Lambda_{N}+S_{N}
\end{align}
The terms of the particle conservation thus read
\begin{align}
  N= & N,\\
  \vec j_{N} =& N\left(
  \vec u_\psi + \vec u_C + \vec u_{K} +U_\parallel\left(\bhat+{\vec b}_\perp\right)  \right)
\label{eq:particle_flux}\\
  %\nonumber\\
  %=& N \left(\frac{\bhat\times \vn\phi}{B}
  %+ \tau_e \frac{\bhat\times\vn n_e}{n_eB}
  %+ \mu_e u_{\parallel,e}^2\vec K_{\vn\times\bhat}
  %+ u_{\parallel,e}(\bhat + {\vec b}_\perp) \right), \\
  \Lambda_{N} =& \Lambda_N
\\
  S_{N} =&  S_{N}
\end{align}
Notice that
\begin{align}
\tau N \vec K = \tau N\vn\times\frac{\bhat}{B} = \tau \vn\times N\frac{\bhat}{B} + \tau \frac{\bhat\times\vn N}{B}
\label{}
\end{align}
such that we can define the diamagnetic flux in the particle flux since
the rotation vanishes under the divergence.

We here also derive the particle flux \eqref{eq:particle_flux} through a flux surface
\begin{align} \label{eq:radial_particle_flux}
 \vec j_{N}\cn v %=& N\left( \vec u_E + \vec u_C + \vec u_{\vn
 %B} + U_\parallel \left(\bhat + {\vec b}_\perp\right)\right) \cn \psi_p \nonumber\\
 =&
  \frac{\d v}{\d \psi_p} N\left[\frac{1}{B}[\psi, \psi_p]_\perp + \left(\tau + \mu U_\parallel^2\right)
   \mathcal K_{\vn\times\bhat}(\psi_p) + \tau  \mathcal K_{\vn B}(\psi_p) \right] \nonumber\\
 &+ NU_\parallel\frac{\d v}{\d \psi_p}\left [\left( A_\parallel \mathcal
 K_{\vn\times\bhat}(\psi_p) + \frac{1}{B}[\psi_p, A_\parallel]_\perp\right) \right]
\end{align}
The relevant terms in the output file are
\begin{longtable}{llll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation} & \textbf{Name} &  \textbf{Equation}\\
\midrule
    electrons & $n_e$ &
    jscurvne\_tt &$ n_e  \vec u_K \cn \psi_p$ \\
    jscurvkappane\_tt &$ n_e  \vec u_C \cn \psi_p$ &
    & \\
    jsneA\_tt &$ n_e u_{\parallel,e} \vec{ b}_\perp  \cn \psi_p$ &
    jsneE\_tt & $ n_e \vec u_E\cn\psi_p$ \\
    lneperp\_tt &$ \Lambda_{\perp,n_e} = -\nu_{n,\perp} (-\Delta_\perp)^s n_e$&
    lneparallel\_tt &$ \Lambda_{\parallel,n_e} = \nu_{N\parallel} \Delta_\parallel n_e$ \\
    sne\_tt & $S_{n_e}$ &
    jsdiae\_tt & $\tau_e \bhat \times \vn n_e \cn \psi_p /B$\\
    divjnepar\_tt & $\nc (\bhat n_e u_{e,\parallel}$) &
    divneE\_tt & $\nc ( n_e \vec u_E)$ \\
    divcurvne\_tt & $\nc( \tau_e \vec K n_e)$ &
    divcurvkappane\_tt & $\nc( \mu_e n_e u_{\parallel,e}^2 \KK)$ \\
    divneA\_tt & $\nc (\bhat n_e u_{e,\parallel} {\vec b}_\perp)$) &
     &  \\
    ions & $N_i$ &
    jscurvni\_tt &$ N_i \vec u_K \cn \psi_p$ \\
    jscurvkappani\_tt &$ N_i \vec u_C \cn \psi_p$ &
    & \\
    jsniA\_tt &$ N_i U_{\parallel,i} \vec{ b}_\perp  \cn \psi_p$ &
    jsniE\_tt & $ N_i \vec u^i_E\cn\psi_p$ \\
    lniperp\_tt &$ \Lambda_{\perp,N_i} = -\nu_{n,\perp} (-\Delta_\perp)^s N_i$&
    lniparallel\_tt &$ \Lambda_{\parallel,N_i} = \nu_{N,\parallel} \Delta_\parallel N_i$ \\
    sni\_tt & $S_{N_i}$ &
    jsdiai\_tt & $\tau_i \bhat \times \vn N_i \cn \psi_p /B$\\
    divjnipar\_tt & $\nc (\bhat N_i U_{i,\parallel}$) &
    divniE\_tt & $\nc ( N_i \vec u_{E,i})$ \\
    divcurvni\_tt & $\nc( \tau_i \vec K N_i)$ &
    divcurvkappani\_tt & $\nc( \mu_i N_i U_{\parallel,i}^2 \KK)$ \\
    divniA\_tt & $\nc (\bhat N_i U_{i,\parallel} {\vec b}_\perp)$) &
     &  \\
\bottomrule
\end{longtable}

Note that the parallel divergences vanish exactly under a flux-surface average. This can serve as a numerical test of our implementation.
\subsection{Energy theorem, "Energy-theorem"}
The terms of the energy theorem are
\begin{align} \label{eq:energy_theorem}
\partial_t \mathcal E +
\nc \vec j_{\mathcal E}
= \Lambda_{\mathcal E}
+  S_{\mathcal E}
+  R_{\mathcal E}
\end{align}
with ( $z_e=-1$ and $z_i=+1$) and $\vec u_E := {\bhat\times \vn\phi}/{B}$
\begin{align} \label{eq:energy_conservation}
  \mathcal{E}= & z_e\tau_e n_e \ln{(n_e)} +z_i\tau_i N_i\ln{(N_i)}
  +\frac{1}{2\beta}\left(\np A_\parallel\right)^2
   +  \frac{1}{2} z_i \mu_i N_i u_E^2  \nonumber\\
   & +\frac{1}{2} z_e\mu_e  n_e u_{\parallel,e}^2
  +\frac{1}{2} z_i\mu_i  N_i U_{\parallel,i}^2,\\
  \vec j_{\mathcal E} =& \sum_s z\left[
  \left(\tau \ln N + \frac{1}{2}\mu U_\parallel^2 + \psi \right)N\left(
  \vec u_E + \vec u_C + \vec u_{K} +U_\parallel\left(\bhat+{\vec b}_\perp\right)  \right) \right]
  \nonumber\\
  &+ \sum_z z\left[\mu \tau NU_\parallel^2\vec K_{\vn\times\bhat} + \tau NU_\parallel \left(\bhat + {\vec b}_\perp\right)\right], \\
  \Lambda_{\mathcal E} =&  \sum_s z\left[\left( \tau\left( 1+\ln{N}\right) + \psi + \frac{1}{2} \mu U_\parallel^2 \right)
  \Lambda_N  +  \mu NU_\parallel\Lambda_U  \right]
\nonumber \\
  S_{\mathcal E} =&  \sum_s  z\left[ \left(\tau\left( 1+\ln{N}\right) +\psi - \frac{1}{2} \mu U_\parallel^2 \right)S_{N}\right]
\nonumber \\
R_{\mathcal E} =&  -\eta_\parallel  n_e(U_{\parallel,i}-u_{\parallel,e})(N_iU_{\parallel,i} - n_eu_{\parallel,e}).
\end{align}
where in the energy flux $\vec j_{\mathcal E}$
we neglect terms  containing time derivatives
of the eletric and magnetic potentials and we sum over all species.
The energy density $\mathcal E$ consists of the Helmholtz free energy density for electrons and ions,
the \(\vec{E} \times \vec{B}\) energy density, the parallel energy densities for electrons and ions and the perturbed magnetic field energy density.
In \(\Lambda\) we insert the dissipative terms of Section~\ref{sec:dissres}. \\
Replace $\Delta_\perp$ with $-\Delta_\perp^2$ when hyperviscous diffusion is chosen
for the diffusion terms in the above equations.

We have the energy flux through a flux surface
\begin{align}
 \vec j_{\mathcal E}\cn v =&%\frac{\d v}{\d \psi_p} \vec j_{\mathcal E}\cn \psi_p  =
\frac{\d v}{\d \psi_p}\sum_s z\left (\tau\ln N + \frac{1}{2}\mu U_\parallel^2 + \psi\right) \vec j_N\cn\psi_p
+ z \mu\tau NU_\parallel^2 \mathcal K_{\vn\times\bhat}(\psi_p) \nonumber\\
&+ z \tau NU_\parallel
 \left( A_\parallel \mathcal
 K_{\vn\times\bhat}(\psi_p) + \frac{1}{B}[\psi_p, A_\parallel]_\perp\right)
\label{eq:energy_flux}
\end{align}
The relevant terms in the output file are
\begin{longtable}{ll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation}\\
\midrule
    nelnne &$ z_e\tau_e n_e \ln n_e$ \\
    nilnni &$ z_i\tau_i N_i \ln N_i$ \\
    aperp2 &$ (\np A_\parallel)^2/2/\beta$ \\
    ue2   &$z_i\mu_i N_i u_E^2 /2$ \\
    neue2 &$ z_e\mu_e n_e u_{\parallel,e}^2/2$ \\
    niui2 &$ z_i\mu_i N_i U_{\parallel,i}^2/2$ \\
    see\_tt & $z_e(\tau_e (1+\ln n_e) + \phi + \frac{1}{2}\mu_e u_{\parallel,e}^2) S_{n_e} $ \\
    sei\_tt & $z_i(\tau_i (1+\ln N_i) + \psi + \frac{1}{2}\mu_i U_{\parallel,i}^2) S_{N_i} $ \\
    resistivity\_tt &-$\eta_\parallel n_e (U_{\parallel,i}-u_{\parallel,e})(N_iU_{\parallel,i}-n_eu_{\parallel,e})$ \\
    jsee\_tt &$z_e(\tau_e \ln n_e + \mu_e u_{\parallel,e}^2/2 + \phi)n_e(\vec u_E + \vec u_C + \vec u_K)\cn \psi_p
        + z_e \tau_e n_e u_{\parallel,e}^2 \vec K_{\vn\times\bhat}\cn \psi_p$ \\
    jsei\_tt &$z_i(\tau_i \ln N_i + \mu_i U_{\parallel,i}^2/2 + \psi_i)N_i(\vec u_E^i + \vec u_C + \vec u_K)\cn \psi_p
        + z_i \tau_i N_i U_{\parallel,i}^2 \vec K_{\vn\times\bhat}\cn \psi_p$ \\
    jseea\_tt &$z_e(\tau_e \ln n_e + \mu_e u_{\parallel,e}^2 + \phi)n_e \vec { b}_\perp\cn \psi_p
        + z_e \tau_e n_e u_{\parallel,e} \vec{ b}_\perp \cn \psi_p $ \\
    jseia\_tt &$z_i(\tau_i \ln N_i + \mu_i U_{\parallel,i}^2 + \psi_i)N_i \vec { b}_\perp\cn \psi_p
        + z_i \tau_i N_i U_{\parallel,i} \vec{ b}_\perp \cn \psi_p $ \\
    divee\_tt &$\nc \vec j_{\mathcal E}^e$ \\
    divei\_tt &$\nc \vec j_{\mathcal E}^i$ \\
    diveea\_tt &$\nc \vec j_{\mathcal E,A}^e$\\
    diveia\_tt &$\nc \vec j_{\mathcal E,A}^i$\\
    leeperp\_tt &$z_e(\tau_e(1+\ln n_e) + \phi + \mu_eu_{\parallel,e}^2/2) \Lambda_{n_e,\perp} + z_e\mu_e n_e u_{\parallel,e} \Lambda_{u_e,\perp}$ \\
    leiperp\_tt &$z_i(\tau_i(1+\ln N_i) + \psi_i + \mu_iU_{\parallel,i}^2/2) \Lambda_{N_i,\perp} + z_i\mu_i N_i U_{\parallel,i} \Lambda_{U_i,\perp}$ \\
    leeparallel\_tt & $z_e(\tau_e(1+\ln n_e) + \phi + \mu_eu_{\parallel,e}^2/2) \Lambda_{n_e,\parallel} +
    z_e\mu_e u_{\parallel,e} \Lambda_{u_e, \parallel}$ \\
    leiparallel\_tt & $z_i(\tau_i(1+\ln N_i) + \psi_i + \mu_iU_{\parallel,i}^2/2)\Lambda_{N_i,_\parallel} +
    z_i\mu_i U_{\parallel,i} \Lambda_{U_i,\parallel}$ \\
    %leeparallel\_tt & $ z_e\mu_e u_{\parallel,e} \nu_{\parallel,e} \Delta_\parallel u_{\parallel,e}$ \\
    %leiparallel\_tt & $ z_i\mu_i U_{\parallel,i} \nu_{\parallel,i} \Delta_\parallel U_{\parallel,i}$ \\
    divjeepar\_tt &$ z_e\nc \left( (\tau_e(1+\ln n_e) + \phi + \mu_eu_{\parallel,e}^2/2) n_eu_{\parallel,e}\bhat\right)$ \\
    divjeipar\_tt &$ z_i\nc \left( (\tau_i(1+\ln N_i) + \psi + \mu_iU_{\parallel,i}^2/2) N_iU_{\parallel,i}\bhat\right)$ \\
\bottomrule
\end{longtable}

\subsection{Toroidal ExB angular momentum equation, "Toroidal-momentum"} \label{sec:vorticity_eq}
We integrate the polarisation equation over volume, multiply by $\d \psi_p/\d v$ and derive by time. In the drift-ordering up to order $\mathcal O(\delta^3)$ we get
\begin{align}
    &\partial_t \RA{\Omega} + \frac{\partial}{\partial v}\frac{\d v}{\d\psi_p}\RA{\vec j_\Omega\cn\psi_p} = -\RA{F_{L,\varphi}} + \RA{\mathcal S_\Omega} \label{eq:vorticity_average} \\
\Omega &:= \mu_i N_i \left(\frac{\vn\psi_p\cn\phi}{B^2} + \tau_i \vn\ln N_i\cn\psi_p\right) \equiv \mu_i N_i(u_{E,\varphi} + u_{D,\varphi}) \\
\vec j_{\Omega} &:= \Omega \vec u_E
    - \left(\frac{1}{\beta} \vn\psi_p \cn A_\parallel +\frac{1}{2}\tau_i \vn\psi_p\cn  (N_iU_{\parallel,i})\right)\frac{\bhat\times\vn A_\parallel}{B} \\
    F_{L,\varphi} &:=  -(z_e \tau_e n_e + z_i\tau_i N_i)\mathcal K(\psi_p) - (z_e\mu_e n_eu_{\parallel,e}^2 + z_i\mu_i N_iU_{\parallel,i}^2)\mathcal K_{\vn\times\bhat}(\psi_p) \\
    \mathcal S_\Omega &:= \mu_i S_{n_e} \frac{\vn\psi_p\cn \phi}{B^2} + \mu_i\tau_i\vn\psi_p\cn S_{n_e} \label{eq:em_source}
\end{align}
Equation~\eqref{eq:vorticity_average} can be rewritten by inserting the continuity equation to yield an equation only for the \ExB angular momentum. Again up to order $\mathcal O(\delta^3)$ in the drift ordering we obtain
(the diffusive term is for testing purposes)
\begin{align}
&\partial_t \RA{\Omega_E} + \frac{\partial}{\partial v} \frac{\d v}{\d \psi_p}\RA{ \vec j_{\Omega_E}\cn\psi_p} = -\RA{F_{L,\varphi}}+ \RA{\mathcal S_{\Omega_E}} + \RA{\Lambda_{\Omega_E}} \label{eq:exb_average} \\
\Omega_E &:= \mu_i N_i \frac{\vn\psi_p\cn\phi}{B^2} \equiv \mu_i N_i u_{E,\varphi} \\
\vec j_{\Omega_E} &:= \Omega_E (\vec u_E + \vec u_D)
    - \vn A_\parallel\cn\psi_p \left(\frac{1}{\beta} \frac{\bhat\times\vn A_\parallel}{B} +\frac{1}{2} \bhat \times \vn \mu_i \tau_i N_iU_{\parallel,i}\right) \\
    \mathcal S_{\Omega_E} &:= \mu_i S_{n_e} \frac{\vn\psi_p\cn\phi}{B^2} \quad
    \Lambda_{\Omega_E} := \mu_i \Lambda_{n_e}\frac{\vn\psi_p\cn\phi}{B^2}
\end{align}
where here we also monitor the source and diffusion terms.
In the output file we have
\begin{longtable}{llll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation}&
\textbf{Name} &  \textbf{Equation}\\
\midrule
    oexbi &$\mu_i N_i \frac{\vn\psi_p\cn\phi}{B^2}$ &
    oexbe &$\mu_i n_e \frac{\vn\psi_p\cn\phi}{B^2}$ \\
    odiai &$\mu_i \tau_i\vn\psi_p\cn N_i$ &
    odiae &$\mu_i \tau_i\vn\psi_p\cn n_e$ \\
    divoexbi\_tt &$\mu_i \nc( N_i \frac{\vn\psi_p\cn\phi}{B^2} \vec u_E)$ &
    divoexbe\_tt &$\mu_i \nc( n_e \frac{\vn\psi_p\cn\phi}{B^2} \vec u_E)$ \\
    divoexbiUD\_tt &$\mu_i\tau_i \nc( \frac{\vn\psi_p\cn\phi}{B^2} \frac{\bhat\times\vn N_i}{B})$ &
    divoexbeUD\_tt &$\mu_i\tau_i \nc( \frac{\vn\psi_p\cn\phi}{B^2} \frac{\bhat\times\vn n_e}{B})$ \\
    divodiaiUE\_tt &$\mu_i \tau_i\nc(\vn\psi_p\cn N_i \vec u_E)$ &
    divodiaeUE\_tt &$\mu_i \tau_i\nc(\vn\psi_p\cn n_e \vec u_E)$ \\
    divoApar\_tt &$ -\nc ( \vn\psi_p\cn A_\parallel \frac{\bhat\times\vn A_\parallel}{B\beta})$ &
    & \\
    jsoexbi\_tt &$\mu_i N_i \frac{\vn\psi_p\cn\phi}{B^2} \frac{\bhat\times\vn\phi\cn \psi_p}{B}$ &
    jsoexbe\_tt &$\mu_i n_e \frac{\vn\psi_p\cn\phi}{B^2} \frac{\bhat\times\vn\phi\cn \psi_p}{B}$ \\
    jsodiaiUE\_tt &$\mu_i \tau_i\vn\psi_p\cn N_i \frac{\bhat\times\vn\phi\cn \psi_p}{B}$ &
    jsodiaeUE\_tt &$\mu_i \tau_i\vn\psi_p\cn n_e \frac{\bhat\times\vn\phi\cn \psi_p}{B}$ \\
    jsoexbiUD\_tt &$\mu_i\tau_i \frac{\vn\psi_p\cn\phi}{B^2} \frac{\bhat\times\vn N_i\cn \psi_p}{B}$ &
    jsoexbeUD\_tt &$\mu_i\tau_i \frac{\vn\psi_p\cn\phi}{B^2} \frac{\bhat\times\vn n_e\cn \psi_p}{B}$ \\
    jsoApar\_tt &$ -\vn\psi_p\cn A_\parallel \frac{\bhat\times\vn A_\parallel\cn \psi_p}{B\beta}$ &
    jsodiaApar\_tt & $ -\frac{1}{2}\tau_i \vn\psi_p\cn  (N_iU_{\parallel,i})\frac{\bhat\times\vn A_\parallel}{B}\cn\psi_p$ \\
    jsoexbApar\_tt & $ -\frac{1}{2}\tau_i \bhat\times\vn  (N_iU_{\parallel,i})\cn\psi_p \vn A_\parallel\cn\psi_p$ &
    & \\
    socurve\_tt &$z_e\tau_e n_e \mathcal K(\psi_p)$ &
    socurvkappae\_tt &$z_e\mu_e n_eu_{\parallel,e}^2 \mathcal K_{\vn\times\bhat}(\psi_p)$ \\
    socurvi\_tt &$z_i\tau_i N_i \mathcal K(\psi_p)$ &
    socurvkappai\_tt &$z_i\mu_i N_iU_{\parallel,i}^2 \mathcal K_{\vn\times\bhat}(\psi_p)$ \\
    sosne\_tt & $\mu_i S_{n_e} \vn\psi_p\cn\phi/B^2$ &
    sospi\_tt & $\mu_i \tau_i \vn\psi_p \cn S_{n_e}$\\
    loexbe\_tt & $ \mu_i \Lambda_{n_e} \vn\psi_p\cn\phi/B^2$ & \\
\bottomrule
\end{longtable}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Conservation of Currents (COCE), "COCE"}\label{sec:COCE}
If we want to study the electric field locally, without the flux surface average implemented in the equation at section \ref{sec:vorticity_eq}, the COCE diagnostic is necessary. The equation implemented is 
\begin{equation}
    \partial_t\Omega-\nc\nc(\vec{\omega u_E})=\nc(j_\parallel\bhat+\vec{j_{curv}}+\vec{j_{b_\perp}})+\Omega_S,
    \label{eq:COCE_diagnostic}
\end{equation}   
with the following definitions:
\begin{equation}
\Omega=\Omega_E+\Omega_D=-\nc\vec{\omega}=-\nc(\vec{\omega_D}+\vec{\omega_E})=\nc\left[\frac{m_i}{B^2}\left(\frac{\nabla_\perp p_i}{q_i}+n_i\nabla_\perp\phi\right)\right],
\end{equation}
\begin{equation}
    \Omega_S=\nc\left[\frac{m_i}{B^2}\left(\frac{\nabla_\perp S_{p_i}}{q_i}+S_{n_i}\nabla_\perp\phi\right)\right],
\end{equation}
\begin{equation}
     \vec{j_{curv}}\approx\frac{\bhat\times\nabla(p_e+p_i)}{B}+(j_\parallel A_{1,\parallel}+\sum_s m_s n_s u_{\parallel,s}^2) \frac{\nabla\times\bhat}{B}=\vec{j_{d}}+\vec{j_A}+\vec{j_\kappa},
\end{equation}
\begin{equation}
      \vec{j_{b_\perp}}=(j_\parallel+j_{mag})\vec{b_\perp}-\nc(\vec{M^{em}}\vec{b_\perp})=j_\parallel\vec{b_\perp}+\vec{j_{M^{em}}}.
\end{equation}

The implemented terms are defined as follows:
\begin{longtable}{ll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation}\\
\midrule
    v\_Omega\_E\_gf &$ \mu_i\nc(\frac{N_i\vec{\nabla_\perp}\phi}{B^2})$ \\
    v\_Omega\_D\_gf &$ \mu_i\tau_i \Delta_\perp N_i$ REMOVED! use laplace\_ne and laplace\_ni \\
    v\_adv\_E\_main\_gf\_tt &$ \mu_i\nc(\nc (\frac{N_i\vec{\nabla_\perp}\phi}{B^2})\vec{u_E})   $\\
    v\_adv\_E\_rest\_gf\_tt &$ \mu_i\nc(\frac{N_i\vec{\nabla_\perp}\phi}{B^2}\cdot\nabla \vec{u_E})  $\\
    v\_adv\_D\_main\_gf\_tt &$  \mu_i\tau_i \nc((\Delta_\perp N_i)\vec{u_E})   $\\
    v\_adv\_D\_rest\_gf\_tt &$  \mu_i\tau_i \nc(\vec{\nabla_\perp} N_i\cdot\nabla \vec{u_E})  $\\
    v\_M\_em\_gf\_tt &$  -\nc\nc(\vec{M^{em}}\vec{b_\perp})$ REMOVED! we have no $\Gamma_1 A_\parallel$ terms \\
    v\_J\_mag\_tt &$ \nc(j_{mag,||}\vec{b_\perp})=(\tau_i/2)\nc\left(\Delta_\perp( N_i U_{i,\parallel})\vec{b_\perp}\right)  $\\
    v\_J\_bperp\_tt &$ \nc(j_{||}\vec{b_\perp}) = \nc ((N_i U_{\parallel,i} - n_e u_{\parallel,e})\vec b_\perp)$ yields the Maxwell stress\\
    v\_J\_D\_gf\_tt &$ \nc\left(\frac{\bhat\times(\tau_i\vec{\nabla_\perp} N_i-\tau_e\vec{\nabla_\perp} n_e)}{B}\right) $ REMOVED! use divcurvn*\\
    v\_J\_par\_tt &$ \nc((N_i U_{i,\parallel} - n_e u_{e,\parallel})\bhat)  $ REMOVED! use divjnipar-divjnepar\\
    v\_J\_NUK\_gf\_tt &$ \nc((\mu_iN_iU_{i,\parallel}^2-\mu_en_eu_{e,\parallel}^2)\KK)  $ REMOVED! use divcurvkappa*\\
    v\_J\_JAK\_tt &$ \nc(J_\parallel A_{1,\parallel}\KK)  $ REMOVED! part of v\_J\_bperp\\
    v\_S\_E\_tt &$ \mu_i\nc(\frac{S_N\np\phi}{B^2})  $\\
    v\_S\_D\_tt &$ \mu_i\tau_i\nc(\np S_{N})  $\\
    RFB\_E\_r\_GradPsip\_tt &$ -\vec{\nabla}\phi\cn\psi_p  $\\
    RFB\_GradPi\_GradPsip\_tt &$ \tau_i\vec{\nabla} n_e/n_e\cn\psi_p  $\\
\bottomrule
\end{longtable}
Some of these definitions have "\_gf" in their definitions, as they are defined with the gyro-fluid ion density $N_i$. These quantities are also saved without this label, when using the electron fluid density $n_e$ instead of $N_i$. At the same time, all the gradients and divergences in the perpendicular direction are implemented with the toroidal field approximation.


\subsection{Parallel momentum balance, "Parallel-momentum"}
The ion parallel momentum balance reads
\begin{align}
    \mu \frac{\partial}{\partial t} \left(N U_\parallel\right) &+ \mu \nc \left( NU_\parallel \left(
    \vec u_E + \tau \vec K + \mu U_\parallel^2 \KK + U_\parallel\left(\bhat + {\vec b}_\perp\right)
    \right)\right)  \nonumber \\
    &+ 2\mu \nc ( NU_\parallel \tau \KK)
    -\mu NU_\parallel\nc \tau \KK
    + \mu NU_\parallel\mathcal K_{\vn\times\bhat}(\psi) \nonumber\\
    =& -\tau \left(\bhat + {\vec b}_\perp\right)\cn N
    -N \left( \left(\bhat+{\vec b}_\perp\right)\cn \psi + \frac{\partial A_\parallel}{\partial t}\right)
    - \eta n_e(N_iU_{\parallel,i}-n_eu_{\parallel,e})
    \nonumber\\
    &+ \mu N\Lambda_U + \mu U_\parallel \Lambda_N
\end{align}
The flux surface average over the parallel momentum equations under species summation  yields up to order $\mathcal O(\delta^3)$ in the drift-ordering
\begin{align}
  \frac{\partial}{\partial t}\RA{\mu_iN_iU_{\parallel,i} }
    % \nonumber\\
    + \frac{\partial}{\partial v} \frac{\d v}{\d\psi_p} \RA{\mu_iN_iU_{\parallel,i} \frac{\bhat\times\vn\phi}{B}\cn\psi_p + \sum_s (z_s\tau_sN_s + z_s\mu_s N_sU_{\parallel,s}^2) b_{\perp}^{\;v}  }
    \nonumber\\
   = \sum_s\RA{-z_s\tau_s \npar N_s}
   \label{eq:parallel_momentum}
\end{align}
while the toroidal parallel angular momentum contribution reads up to order $\mathcal O(\delta^3)$
\begin{align}\label{eq:parallel_momentum_direction}
    \frac{\partial}{\partial t}  \RA{\mu_iN_iU_{\parallel,i} b_\varphi}
    + \frac{\partial}{\partial v} \frac{\d v}{\d\psi_p} \RA{\mu_iN_iU_{\parallel,i} b_\varphi\frac{\bhat\times\vn\phi}{B}\cn\psi_p + \sum_s (z_s\tau_s N_s + z_s\mu_sN_sU_{\parallel,s}^2) b_\varphi b_{\perp}^{\;v} }
    \nonumber\\
    = R_0 \RA{F_{L,\varphi}}
\end{align}
The $R_0$ in the term on the right hand side stems from the normalisation of $\psi_p$.
\begin{tcolorbox}[title=Note]
The source terms add up to zero with our choice of the parallel velocity source~\eqref{eq:velocity_source}.
\end{tcolorbox}
The relevant terms in the output file are (the Lorentz force term is described in the previous subsection \ref{sec:vorticity_eq})
\begin{longtable}{llll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation} &
\textbf{Name} &  \textbf{Equation}\\
\midrule
    niui &$\mu_i N_i U_{\parallel,i}$ &
    niuibphi &$\mu_i N_iU_{\parallel,i}b_\varphi$ \\
    jsparexbi\_tt       & $\mu_i N_iU_{\parallel,i}(\bhat\times\vn\phi)\cn \psi_p/B$ &
    jsparbphiexbi\_tt   & $\mu_i N_iU_{\parallel,i}b_\varphi(\bhat\times\vn\phi)\cn \psi_p/B$ \\
    divparexbi\_tt       & $\mu_i \nc (N_iU_{\parallel,i}\vec u_E)$ &
    divparbphiexbi\_tt   & $\mu_i\nc( N_iU_{\parallel,i}b_\varphi \vec u_E)$ \\
    divparexbii\_tt       & $\mu_i \nc (N_iU_{\parallel,i}\vec u_E^i)$ &
    divparbphiexbii\_tt   & $\mu_i\nc( N_iU_{\parallel,i}b_\varphi \vec u_E^i)$ \\
    divpardiai\_tt       & $\nc(\mu_i \tau_i N_iU_{\parallel,i}\vec K)$ &
    divparbphdiai\_tt   & $\nc ( \mu_i \tau_i N_iU_{\parallel,i}b_\varphi\vec K)$ \\
    divparkappai\_tt       & $\nc (\mu_i N_iU_{\parallel,i} ( \mu_i U_{\parallel,i}^2 + 2\tau_i)\KK )$ &
    divparbphikappai\_tt       & $\nc( \mu_i N_iU_{\parallel,i}b_\varphi ( \mu_i U_{\parallel,i}^2 + 2\tau_i)\KK)$ \\
    divparmirrorAi\_tt       & $\nc(z_i \tau_i N_i \vec b_\perp)$ &
    divparbphiApar\_tt   & $\sum_s \nc ((z_s \tau_s N_s + z_s \mu_s N_s U_{\parallel,s}^2)b_\varphi \vec b_\perp)$ \\
    divparmirrorAe\_tt       & $-\nc ( n_e \vec b_\perp)$ &
    & \\
    divparApari\_tt       & $\nc( z_i \mu_i N_i U_{\parallel,i}^2\vec b_\perp)$ &
    & \\
    divparApare\_tt       & $\nc( z_e \mu_e n_e u_{\parallel,e}^2\vec b_\perp)$ &
    & \\
    divjpari\_tt & $ \nc( +\mu_i N_i U_{\parallel,i}^2 \bhat)$ &
    & \\
    divjpare\_tt & $ \nc( -\mu_e n_e u_{\parallel,e}^2 \bhat)$ &
    & \\
    lparpar\_tt   & $N_i \Lambda_{U_i,\parallel} + U_{\parallel,i} \Lambda_{N_i,\parallel}$ &
    lparperp\_tt & $U_{\parallel,i} \Lambda_{N_i} + N_i\Lambda_{U_i} $ \\
    lparparbphi\_tt   & $(N_i \Lambda_{U_i,\parallel} + U_{\parallel,i} \Lambda_{N_i,\parallel})b_\varphi$ &
    lparperpbphi\_tt & $(U_{\parallel,i} \Lambda_{N_i} + N_i\Lambda_{U_i})b_\varphi $ \\
    sparKappaphii\_tt & $-\mu_i N_i U_{\parallel,i} \KK\cn \psi_i$ &
    sparmirrorKappai\_tt & $\tau_i N_i U_{\parallel,i} \nc\KK$ \\
    sparphii\_tt & $-N_i\npar \psi$ &
    friction\_tt & $ \eta n_e(N_iU_{\parallel,i}-n_eu_{\parallel,e})$ \\
    sparmirrori\_tt & $-\tau_i\npar N_i$ &
    sparmirrorAi\_tt & $-\tau_i \vec b_\perp \cn N_i $ \\
    sparphiAi\_tt & $ -N_i \vec b_\perp \cn \psi $ &
    spardotAi\_tt & $ -N_i \partial A_\parallel /\partial t$ \\
\bottomrule
\end{longtable}
Note that the parallel viscosity term vanishes exactly under the flux-surface average. This can serve as a numerical test.

We gather the dominant terms in the electron momentum equation (neglecting all terms as $\mu_e=0$). This leaves the parallel force balance
\begin{align}
    -(\bhat + \vec b_\perp) \cn n_e +n_e\left( \left( \bhat + \vec b_\perp \right) \cn \phi + \frac{\partial A_\parallel}{\partial t} \right) +\eta n_e \left( N_iU_{\parallel,i} - n_eu_{\parallel,e}\right) = 0
\end{align}
Further we can compare if the following terms are small in the electron force balance
\begin{align*}
    \nc( z_e \mu_e n_e u_{\parallel,e}^2\vec b_\perp)\\
    \RA{\nc ( \vec b_\perp n_e )} = \RA{n_e \vec b_\perp \cn n_e}
\end{align*}
\begin{longtable}{llll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation} &
\textbf{Name} &  \textbf{Equation}\\
\midrule
    sparphie\_tt & $n_e\npar \phi$ &
    friction\_tt & $ \eta n_e(N_iU_{\parallel,i}-n_eu_{\parallel,e})$ \\
    sparmirrore\_tt & $-\npar n_e$ &
    sparmirrorAe\_tt & $-\vec b_\perp \cn n_e $ \\
    sparphiAe\_tt & $n_e \vec b_\perp \cn \phi$ &
    spardotAe\_tt & $ n_e \partial A_\parallel /\partial t$ \\
    neue &$n_e u_{\parallel,e}$ &
    & \\
\bottomrule
\end{longtable}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\subsection{Zonal flow energy, "Zonal-Flow-Energy"}

\begin{align}
    E_\mathrm{zonal} = \frac{1}{2}\RA{\rho_M}\FA{ \iota^{-2}\mathcal I^{\vartheta\vartheta} + 2\iota^{-1}\mathcal I^{\vartheta\varphi} + \mathcal I^{\varphi\varphi}} \FA{u_{E,\varphi}}^2
    \equiv \frac{1}{2} \RA{\rho_M} \FA{u_{E,\varphi}}^2  \FA{\mathcal I_0}
    \label{eq:zonal_energy}
\end{align}
For symmetry flux coordinates we have $g_{\vartheta\vartheta} = R^2 (\vn\psi_p)^2/I^2\iota^2$, $g_{\varphi\vartheta} =0$ and $g_{\varphi\varphi}=R^2$ and thus $\mathcal I_0 = R^{-2}( 1 + I^2/|\vn\psi_p|^2)= B^2 / (R_0^2|\vn\psi_p|^2)$. (In dimensionless notations; note that $g_{ij}$ has units of $\rho_s^2$ and $\mathcal I_0$ has units $\rho_s^{-2}$)
\begin{align}\label{eq:perp_kinetic}
      \frac{\partial}{\partial t}E_{\mathrm{zonal}} +\frac{\partial}{\partial v } \left(E_{\mathrm{zonal}}\FA{u^v} \right)
  =&-\FA{\mathcal I_0}\FA{u_{E,\varphi}}\left(\frac{\partial }{\partial v}  \Theta_{\varphi}^{\; v} + \RA{(\vec j_f\times\vec B)_\varphi}\right)
  \nonumber\\
    &-\frac{1}{2}\FA{u_{E,\varphi}}^2\frac{\partial}{\partial v}\left(\RA{\rho_M}\FA{\FF{\mathcal I_0}\FF{u^v}}\right)
     + \mathcal S_{\mathrm{zonal}}
\end{align}
where we neglected the term $\RA{n\vec u\cn \mathcal I_0}$ in the continuity equation as small in our ordering
 and we have
 \begin{align}
 \mathcal S_{\mathrm{zonal}} :=& \FA{\mathcal I_0} \FA{u_{E,\varphi}} \mathcal S_{u_{E,\varphi}} + \frac{1}{2}\FA{u_{E,\varphi}}^2  \RA{mS_n\mathcal I_0}
%  \nonumber\\
 \label{eq:zonal_source}
 \end{align}
 and in the output file
\begin{longtable}{llll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation} &
\textbf{Name} &  \textbf{Equation}\\
\midrule
    nei0 &$n_e \mathcal I_0$ &
    snei0\_tt & $S_{n_e } \mathcal I_0$ \\
\bottomrule
\end{longtable}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Probes Output}\label{sec:probes-output}
The probes output is stored in a netcdf group called "probes" in the main output file
%
%Name | Type | Dimensionality | Description
%---|---|---|---|
\begin{longtable}{lll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Dimension} & \textbf{Description}  \\ \midrule
format           & text attribute   & - & The format value as a styled string \\
dim              & Coord. Var. & 1 (dim) & index-like-coordinate $\in [0,1]$ \\
time             & Coord. Var. & 1 (time)& time at which fields are written (variable size: itstp*maxout$+1$, dimension size: unlimited) \\
X                & Dataset & 1 (dim)      & Static field data \\
Y                & Dataset & 2 (time,dim) & Dynamic measurements \\
\bottomrule
\end{longtable}
where $X\in $["R","Z","P", "a collection of magnetic field quantities (check output file for details"]
and $Y\in $
\begin{longtable}{llllll}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Equation} & \textbf{Name} &  \textbf{Equation} & \textbf{Name} & \textbf{Equation}\\
\midrule
    ne &$n_e$ &
    ni &$N_i$ &
    ue &$u_{\parallel,e}$ \\
    ui &$U_{\parallel,i}$ &
    phi &$\phi$ &
    apar &$A_\parallel$ \\
    neR &$\partial_R n_e$ &
    niR &$\partial_R N_i$ &
    ueR &$\partial_R u_{\parallel,e}$ \\
    uiR &$\partial_R U_{\parallel,i}$ &
    phiR &$\partial_R \phi$ &
    aparR &$\partial_R A_\parallel$ \\
    neZ &$\partial_Z n_e$ &
    niZ &$\partial_Z N_i$ &
    ueZ &$\partial_Z u_{\parallel,e}$ \\
    uiZ &$\partial_Z U_{\parallel,i}$ &
    phiZ &$\partial_Z \phi$ &
    aparZ &$\partial_Z A_\parallel$ \\
    nePar &$\npar n_e$ &
    niPar &$\npar N_i$ &
    uePar &$\npar u_{\parallel,e}$ \\
    uiPar &$\npar U_{\parallel,i}$ &
    phiPar &$\npar \phi$ &
     & \\
\bottomrule
\end{longtable}
with all these quantities available most other quantities (flux, energy, etc.)
can be computed in post processing.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Diagnostics}\label{sec:diagnostics}
\mintinline{bash}{feltor/src/feltor/feltordiag.cu}
reads one or more previously generated simulation file(s) \mintinline{bash}{input0.nc
 ... inputN.nc} described in Section~\ref{sec:output_file} and writes into a
 single second output file \mintinline{bash}{output.nc} described as follows. \\
Compilation
\mint{bash}{make feltordiag device={gpu,omp}}
\noindent Usage
\mint{bash}{./feltordiag configuration.json input0.nc ... inputN.nc output.nc}
The usage requires a file \mintinline{bash}{configuration.json} where parameters for the diagnostic can be introduced and is described further down.
\begin{tcolorbox}[title=Note]
\mintinline{bash}{feltordiag} refuses to overwrite existing files in order to protect against data loss in case of accidental spelling
errors or other careless mistakes.
\end{tcolorbox}

Output file format: \href{https://www.unidata.ucar.edu/software/netcdf/docs/}{netcdf-4/hdf5};
\href{http://cfconventions.org/Data/cf-conventions/cf-conventions-1.7/cf-conventions.html}{CF Conventions CF-1.7}

A \textit{coordinate variable (Coord. Var.)} is a Dataset with the same name as a dimension.

\begin{longtable}{lll>{\RaggedRight}p{7cm}}
\toprule
\rowcolor{gray!50}\textbf{Name} &  \textbf{Type} & \textbf{Dimension} & \textbf{Description}  \\ \midrule
inputfile  &     text attribute & - & verbose input file as a string (valid JSON, C-style comments are allowed but discarded) \\
configfile   &     text attribute & - & verbose configuration file as a string (valid JSON, C-style comments are allowed but discarded) \\
x                & Coord. Var. & 1 (x) & $R$-coordinate (computational space, compressed size: $nN_x/c_x$)\\
y                & Coord. Var. & 1 (y) & $Z$-coordinate (computational space, compressed size: $nN_y/c_y$)\\
psi              & Coord. Var. & 1 (psi) & $\psi_p$-coordinate ( default size: $3\cdot 64$) \\
eta              & Coord. Var. & 1 (eta) & $\eta$-coordinate ( default size: $3\cdot 640$) \\
xc               & Dataset & 2 (eta,psi) & Cartesian x-coordinate of the FSA grid \\
yc               & Dataset & 2 (eta,psi) & Cartesian y-coordinate of the FSA grid\\
vol              & Dataset & 2 (eta,psi) & Volume form in 2d including dG weights (can be used to integrate 2d quantities on the FSA grid; multiply by $2\pi$xc to get 3d volume)  \\
time             & Coord. Var. & 1 (time)& time at which fields are written (variable size: maxout$+1$, dimension size: unlimited) \\
dvdpsip          & Dataset & 1 (psi) & $\d v/\d\psi_p$ \\
psi\_vol         & Dataset & 1 (psi) & The volume enclosed by the flux surfaces $v(\psi_p) = \int_{\psi_p} \dV $ \\
psi\_area        & Dataset & 1 (psi) & The area of the flux surfaces $A(\psi_p) = 2\pi \int_\Omega |\vn\psi_p| \delta(\psi_p - \psi_{p0}) H(Z-Z_X) R\d R\d Z$ \\
dv2ddpsip        & Dataset & 1 (psi) & $\d v/\d\psi_p$ (in the 2d poloidal plane) \\
psi\_vol2d       & Dataset & 1 (psi) & The 2d volume enclosed by the flux surfaces $v(\psi_p) = \int_{\psi_p} dRdZ $ \\
psi\_arc         & Dataset & 1 (psi) & The arc length of the flux surfaces $L(\psi_p) = 2\pi \int_\Omega |\vn\psi_p| \delta(\psi_p - \psi_{p0}) H(Z-Z_X) \d R\d Z$ \\
q-profile        & Dataset & 1 (psi) & The safety factor $q(\psi_p)$ \eqref{eq:safety_factor} using direct integration ( accurate but we assign random values outside separatrix) \\
psi\_psi         & Dataset & 1 (psi) & explicit $\psi_p$ values; Same as psi \\
psit1d           & Dataset & 1 (psi) & Toroidal flux (integrated q-profile) $\psi_t = \int^{\psi_p} \d\psi_p q(\psi_p)$ \\
rho              & Dataset & 1 (psi) & Transformed flux label $\rho:= 1 - \psi_p/\psi_{p,O}$ \\
rho\_p           & Dataset & 1 (psi) & poloidal flux label $\rho_p:= \sqrt{1 - \psi_p/\psi_{p,O}}$  ( see Section~\ref{sec:alternative}\\
    rho\_t           & Dataset & 1 (psi) & Toroidal flux label $\rho_t :=
    \sqrt{\psi_t/\psi_{t,\mathrm{sep}}}$ (is similar to $\rho$ in the edge but
    $\rho_t$ is nicer in the core domain, because equidistant $\rho_t$ make
more equidistant flux-surfaces, see Section~\ref{sec:alternative} )\\
Z\_fluc2d        & Dataset & 3 (time,y,x) & Fluctuation level on selected plane ($\varphi= 0$) $\delta Z := Z(R,Z,0) - \RA{ Z}(R,Z)$ \\
Z\_fsa2d         & Dataset & 3 (time, y,x) & Flux surface average $\RA{ Z}$ interpolated onto 2d plane Eq.~\eqref{eq:fsa_vol} \\
Z\_cta2d         & Dataset & 3 (time, y,x) & Convoluted toroidal average Eq.~\eqref{eq:cta} \\
Z\_fsa           & Dataset & 2 (time, psi) & Flux surface average $\RA{ Z}$ Eq.~\eqref{eq:fsa_vol} \\
Z\_std\_fsa      & Dataset & 2 (time, psi) & Standard deviation of flux surface average on selected plane ($\varphi=0$) $\sqrt{\RA{(\delta Z)^2}}$ \\
Z\_ifs           & Dataset & 2 (time, psi) & Volume integrated flux surface average $\int\d v\RA{ Z}$ unless Z is a current, then it is the volume derived flux-surface average $\partial_v \RA{ Z}$ \\
Z\_ifs\_lcfs     & Dataset & 1 (time) & Volume integrated flux surface average evaluated on last closed flux surface $\int_0^{v(0)}\d v\RA{ Z}$ unless Z is a current, then it is the fsa evaluated $\RA{ j_v}(0)$ \\
Z\_ifs\_norm     & Dataset & 1 (time) & Volume integrated square flux surface average $\sqrt{\int \d v \RA{Z}^2}$, unless Z is a current, then it is the square derivative of the flux surface average $\sqrt{\int\d v (\partial_v \RA{j^v})^2}$\\
Z\_cta2dX  & Dataset & 3 (time, psi, eta) & Convoluted toroidal average Eq.~\eqref{eq:cta} in the magnetic plane. \\
\bottomrule
\label{table:diag}
\end{longtable}
where Z $\in$ \{X, Y\_tt\}
\begin{tcolorbox}[title=Note]
    \mintinline{bash}{feltoridag} converts all $jsX$ quantities into $jvX$
by multiplying $\d v/\d \psi_p$
in the sense that $\vec j\cn v  = \vec j \cn \psi_p \d v/\d\psi_p$.
\end{tcolorbox}
The default parameters used for the X-point
\href{https://feltor-dev.github.io/doc/geometries/html/structdg_1_1geo_1_1_separatrix_orthogonal.html}{separatrix-orthogonal Grid}
construction are $f_x = 1/8$, $f_y = 0$, $n_\psi = 3$, $N_\zeta = 64$ and
$N_\eta = 640$ and the constant monitor metric~\cite{Wiesenberger2018}, but can be specified in the \mintinline{bash}{configuration.json} file.
Furthermore, a user can specify which kind of diagnostics quantities should be computed and how:
\begin{minted}[texcomments]{js}
// for feltordiag
"n": 3, // resolution of X-point grid for fsa
"Npsi": 64, // resolution of X-point grid for fsa
"Neta": 640, // resolution of X-point grid for fsa
"Kphi": 10, // resolution for convoluted toroidal average (10 is fine)
"fsa" : "toroidal-average", // From which quantity fsa should be computed, can also be "convoluted-toroidal-average"
"fx_0" : 0.125, // where the separatrix is in relation to the $\zeta$ coordinate
"x-grid-interpolation" : "dg", // type of interpolation for Cylindrical2XGrid
"cta-interpolation" : "dg", // interpolation type in Fieldaligned object for convoluted toroidal averages
"diagnostics" :
[
    "fsa",  // save \_fsa in table \ref{table:diag}.
    "fsa2d", //  save \_fsa2d in table \ref{table:diag}.
    "cta2d", //  save \_cta in table \ref{table:diag}.
    "cta2dX", //  save \_cta2dX in table \ref{table:diag}.
    "fluc2d", //  save \_fluc2d in table \ref{table:diag}.
    "ifs", //  save \_ifs in table \ref{table:diag}.
    "std_fsa", //  save \_std\_fsa in table \ref{table:diag}.
    "ifs_lcfs", //  save \_ifs\_lcfs in table \ref{table:diag}.
    "ifs_norm" //  save \_ifs\_norm in table \ref{table:diag}.
],
// for interpolate in 3d
"fine-grid-factor" : 12, // how many planes are outputted in the new file in total: Nz*fine-grid-factor
"time-reduction-factor" : 10 // only ouptut every *th step
\end{minted}
\begin{tcolorbox}[title=Note]
    If the "diagnostics" field does not exist, all quantities will be selected and written to the output file
\end{tcolorbox}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Flux surface averaging and safety factor}
\subsubsection{Preliminary}
Recall that the {\bf Dirac delta-function} has the property (in any dimension):
\begin{align} \label{eq:dirac_delta}
\int_V f(\vec x) \delta(h(\vec x) - h') \dV = \int_{h=h'} \frac{f(\vec x)}{|\vn h|} \dA
\end{align}
which means that the delta-function can be used to express area integrals of the
submanifold given as a contour of the function $h(\vec x)$.
A numerically tractable approximation to the delta-function reads
\begin{align}\label{eq:delta}
\delta(h(\vec x)-h') = \frac{1}{2\pi \epsilon^2}
\exp\left( - \frac{\left(h(\vec x)-h'\right)^2}{2\epsilon^2}\right)
\end{align}
where $\epsilon$ is a small, free parameter.
In the DG framework the left-hand side
of Eq.~\eqref{eq:dirac_delta} can thus readily be computed
via Gauss-Legendre quadrature, which we propse as a first method to compute area
integrals even if our coordinate system is not aligned to the area.
Note: in order for this to work the Delta function needs to be numerically
resolved and cannot be made arbitrarily small.
This introduces a smoothing effect
over neighboring contour lines which is given by the grid distance.

Furthermore, recall the {\bf co-area formula}
\begin{align} \label{eq:coarea}
\int_{\Omega_0} f(\vec x) \dV =
\int_0^{h_0} \left( \int_{h=h'} \frac{f(\vec x)}{|\vn h|}  \dA  \right) \d h'
\end{align}
where $\Omega_0$ is the volume enclosed by the contour $h=h_0$.
The co-area formula can be viewed as a change of variables in the
volume integral.

We define the {\bf toroidal average} of a function $f(R,Z,\varphi)$ as
\begin{align} \label{eq:phi_average}
\PA{ f}(R,Z) := \frac{1}{2\pi}\oint f(R,Z,\varphi)\d \varphi
\end{align}

In arbitrary coordinates the area 2-form is given by the interior product of the
surface normal with the volume form
\begin{align}
\label{}
\dA^2 = i_{\hat \psi_p} vol^3 \quad \hat \psi_p = \frac{\vn \psi_p}{|\vn \psi_p|}
\end{align}
The pullback to a flux-aligned coordinate system $\{\zeta, \eta, \varphi\}$ is trivial (since $\vn \psi_p$ only has one component $g^{\zeta\zeta} \partial \psi_p / \partial \zeta$) and we have
\begin{align}
\dA &= \sqrt{g^{\zeta\zeta}} \sqrt{g} \d\eta\d\varphi = f_0|\vn\psi_p|\sqrt{g}\d\eta\d\varphi,
\\
\vec\dA &:= \hat\psi_p \dA = f_0 (\vn\psi_p) \sqrt{g}\d\eta\d\varphi,\quad
\label{}
\end{align}
where we used that $g^{\zeta\zeta} = (\vn\zeta)^2 = f_0^2(\vn\psi_p)^2$.
Notice that numerically we can integrate in flux-aligned coordinates by generating a corresponding
grid and pulling back (interpolating) the relevant fields to this grid. This is the second method
to numerically compute area integrals.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Flux surface average}


The flux surface average (as a {\bf volume average} after \cite{haeseleer}) is defined as an average over a
small volume - a shell centered around the flux-surface - defined by two neighboring flux-surfaces.
With the help of the volume
flux label (notice that both the volume $v$ as well as the poloidal flux $\psi_p$ have physical
meaning while the coordinate $\zeta(\psi_p)$ is an arbitrary choice) we define
\begin{align} \label{eq:fsa_vol}
v(\psi_p) :=& \int_{\psi_{p,O}}^\psi \dV = \int^{\zeta(\psi_p)} \sqrt{g}\d\zeta\d\eta\d\varphi,
\\
\frac{\d v}{\d\psi_p} =& \int\dA |\vn\psi_p|^{-1} = 2\pi f_0\oint_{\zeta(\psi_p)} \sqrt{g}\d\eta \\
\RA{ f }_\psi :=& \frac{\partial}{\partial v} \int \dV f
 = \frac{1}{\int \dA |\vn\psi_p|^{-1} } \int_{\psi_p} \frac{f(\vec x)}{|\vn\psi_p|} \dA \nonumber\\
=& \frac{\int_\Omega \PA{ f}(R,Z) \delta(\psi_p(R,Z)-\psi_{p})H(Z-Z_X)\ R \d R \d Z}
{\int_\Omega \delta(\psi_p(R,Z)-\psi_{p})H(Z-Z_X)\ R \d R \d Z}\nonumber\\
 =& \left(\frac{\d v}{\d\psi_p }\right)^{-1} 2\pi f_0 \oint_0^{2\pi} \PA{ f}(\zeta,\eta) \sqrt{g}\d\eta
 = \frac{1}{\oint \sqrt{g}\d\eta } \oint_0^{2\pi} \PA{ f}(\zeta,\eta) \sqrt{g}\d\eta
\end{align}
where we used the co-area formula Eq.~\eqref{eq:coarea} for the second identity
and we use the Heaviside function $H(Z-Z_X)$ to cut away contributions from below the X-point
in our domain $\Omega$.
 We immediately see that this definition is particularly easy to compute
 in a flux-aligned coordinate system. Notice however that the volume element
 does appear (unlike e.g. Tokam3X papers).
 We use our grid construction algorithm with constant monitor metric described in Reference~\cite{Wiesenberger2018} to construct a flux-aligned grid and interpolate
 the values of any function onto its grid points.
 Even though this grid is unusable for simulations due to the diverging metric at the X-point the
 evaluation of integrals works well as the singularity is integrable.

The flux-surface average fulfills the basic identities
\begin{align}
\label{eq:fsa_identities}
\RA{ \mu f + \lambda g} &= \mu\RA{ f} + \lambda \RA{ g} \\
\RA{ f(\psi_p)} &= f(\psi_p)
\end{align}

The volume average is well-suited for density-like quantities
as we can see with the following identity.
Assume we have a quantity $X$ with $\partial_t X + \nc \vec j_X = \Lambda_X$.
Then we can use the volume average to write
\begin{align}
\frac{\partial}{\partial t} \RA{X } + \frac{\partial}{
  \partial v} \RA{ \vec j_X\cn v}  = \RA{ \Lambda_X}
\label{eq:fsa_balance}
\end{align}
where again $v=v(\psi_p)$ is the volume flux label.
The {\bf total flux} of a given flux density $\vec j_X$ through the
flux surface $\psi_p = \psi_{p0}$ is given by
\begin{align}
\RA{\vec j_X\cn v} &:= J_X=\oint_{\psi_p=\psi_{p0}} \vec j_X\cdot \vec{\dA} =
 \frac{\d v}{\d\psi_p} \RA{ \vec j_X\cn\psi_p }\nonumber\\
 &=
   2\pi f_0 \oint_0^{2\pi} \PA{ \vec j_X\cn\psi_p}(\zeta,\eta) \sqrt{g}\d\eta
%2\pi\int_\Omega \vec \PA{ \vec j\cn\psi_p} \delta(\psi_p(R,Z)-\psi_{p0}) H(Z-Z_X)\ R \d R \d Z
\label{eq:total_flux}
\end{align}
Once we have the flux-surface averaged equation we can easily get the volume integrated version (again with the help of the co-area formula)
\begin{align}
\frac{\partial}{\partial t} \int_0^{v(\psi_p)}\RA{X} \d v 
+ \RA{ \vec j_X\cn v}(v(\psi_p))  = \int_0^{v(\psi_p)}\RA{ \Lambda_X}\d v
\label{eq:integral_balance}
\end{align}

\subsubsection{The safety factor}
Assume that we pick a random field line and follow it (integrate it) for exactly one
poloidal turn. The {\bf safety factor} is defined as the ratio between
the resulting toroidal angle ($\Delta\varphi$) to the poloidal angle ($2\pi$)
\begin{align}
q := \frac{\Delta\varphi}{2\pi}
\label{}
\end{align}
Since our magnetic field is symmetric in $\varphi$ and we used one
full poloidal turn this definition is independent of which
fieldline we pick on a given flux surface.

%We define the poloidal length $s$ as the fieldline following
%parameter i.e. $\vec B\cn s \equiv B_p = R_0|\vn \psi_p|/R$
%and $\d\varphi/\d s = B^\varphi(R(s), Z(s)) / B_p(R(s),Z(s))$.
%We can then express the safety factor as the line integral
%\begin{align}
%q=\frac{1}{2\pi}\oint \frac{B^\varphi}{B_p} \d s = \frac{1}{2\pi}\oint_{\psi_p=\psi_{p0}}\frac{I(\psi_p)}{R|\vn\psi_p|} \d s
%= \frac{1}{2\pi}\int \frac{I(\psi_p)}{R}\delta(\psi_p-\psi_{p0}) H(Z-Z_X) \d R\d Z
%\end{align}
%where we made use of Eq.~\eqref{eq:dirac_delta} in two dimensions in the
%last equality and thus arrive at a numerical tractable expression
%to evaluate the safety factor.
We define the geometric poloidal angle $\Theta$ as the fieldline following
parameter i.e. $\vec B\cn\Theta = R_0(\psi_R (R-R_0) + \psi_Z Z)/r^2R$.
We can then directly integrate the safety factor as
\begin{align}\label{eq:safety_factor}
\frac{\d R}{\d\Theta} = \frac{B^R}{B^\Theta}\quad
\frac{\d Z}{\d\Theta} = \frac{B^Z}{B^\Theta}\quad
\frac{\d \varphi}{\d\Theta} = \frac{B^\varphi}{B^\Theta}\\
q\equiv\frac{1}{2\pi}\oint \frac{B^\varphi}{B^\Theta} \d\Theta
\end{align}
We integrate this equation with the help of one of our ODE integrators, i.e. we use a high-order Runge-Kutta method
and refine the stepsize until machine-precision is reached.
\begin{tcolorbox}[title=Note]
The safety factor diverges on the last closed flux
surface whereas Eq.~\eqref{eq:total_flux}
remains finite due to the $\vn\psi_p$ factor. Outside the LCFS $q$ remains undefined.
\end{tcolorbox}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Toroidal averages}
Here, we comment on the $\varphi$ average that is part of the flux-surface average Eq.~\eqref{eq:fsa_vol}.
One simple approach is
quadrature of the form
\begin{align}\label{eq:toroidal_summation}
    \bar f = \frac{1}{N} \sum_{i=0}^{N-1} f_i (R,Z)
\end{align}
where $N=32$ in most of our simulations and $f_i$ is the $i$-th toroidal plane.
Since the boundary conditions in $\varphi$ are periodic this amounts to the trapezoidal rule.
A low number of toroidal planes is sufficient in simulations when we use the toroidal field
approximation in combination with the
flux-coordinate independent (FCI) approach for the parallel derivatives.
However, since the actual $\varphi$ direction is
under-resolved the
integration gives a wrong answer to the actual $\varphi$ average (seen in 2d plots as little humps).
This is because the resulting structures are predominantly field aligned and not toroidally symmetric.

In order to improve the toroidal average we now have the following idea:
if we, before we do the $\varphi$ integration,
interpolate the function to integrate onto a large number of toroidal
planes then the result should
be more accurate than before.
In other words we interpolate the function given on the coarse $\varphi$ simulation grid
onto a hypothetic fine $\varphi$ grid along the magnetic field lines
and only then compute the $\varphi$ average.

Let us divide the $\varphi$ direction between two original planes into $N_\varphi+1$ (a large number) equidistant planes
of distance $\delta \varphi$ and integrate the magnetic field $\vec B$ in between.
\begin{subequations}
\begin{align}
    \frac{\d R}{\d\varphi}&= \frac{B^R}{B^\varphi},\\ %\frac{R}{I}\frac{\partial\psi}{\partial Z},\\
    \frac{\d Z}{\d\varphi}&=\frac{B^Z}{B^\varphi},\\%-\frac{R}{I}\frac{\partial\psi}{\partial R}.
\end{align}
\label{eq:fieldline}
\end{subequations}
We integrate Eqs.~\eqref{eq:fieldline} from $\varphi=0$ to $\varphi=\pm \Delta \varphi$
with initial condition
\begin{align}
    (R(0), Z(0) ) = (R, Z).
    \label{}
\end{align}
Let us characterize the solution $(R(\pm \delta \varphi), Z(\pm \delta \varphi))$ to Eqs.~\eqref{eq:fieldline} as the flow generated by $\vec B/B^\varphi$
\begin{align}
    \Tdpm\vec z \equiv \Tdpm[R, Z, \varphi]:= ( R(\pm \delta\varphi), Z( \pm \delta\varphi), \varphi\pm\delta \varphi),
    \label{}
\end{align}
Obviously we have $\Tdm\circ\Tdp = 1$, but $\Tdpm$ is not necessarily unitary since $\vec B/B^\varphi$ is in general
not divergence free.
We are now able to extend the function $f$ given on the coarse $\varphi$ grid unto the fine $\varphi$ grid via
\begin{align}
    f(R,Z,\varphi_0+j\delta\varphi) = {\Tdm}^j f(R,Z,\varphi_0)\\
    f(R,Z,\varphi_0-j\delta \varphi) = {\Tdp}^j f(R,Z,\varphi_0)
\end{align}
This gives simple 0-th order extrapolation of our function.
Let us call $f_i := f(R,Z,\varphi_i)$ the $i$-th toroidal plane and $N_\varphi$ even. Then
we have the following integration, where we consider the original toroidal planes as cell-centered
\begin{align}
    \RA{f}_\varphi &= \frac{1}{(N_\varphi+1) N} \left[\left(
    {\Tdp}^{N_\varphi/2} f_0 + ... + \Tdp f_0 + f_0 + \Tdm f_0 ... + {\Tdm}^{N_\varphi/2} f_0\right)\right. \nonumber\\
    &\left. +\left( {\Tdp}^{N_\varphi/2} f_1 + ... + \Tdp f_1 + f_1 + \Tdm f_1 ... + {\Tdm}^{N_\varphi/2} f_1\right)  + ... \right] \nonumber\\
    &= \frac{1}{N (N_\varphi+1)} \sum_{i=0}^{N-1} \left[f_i + \sum_{j=1}^{N_\varphi/2} \left( {\Tdm}^j f_i + {\Tdp}^jf_i\right)\right] \nonumber\\
    &=
    \frac{1}{N_\varphi+1} \left[ \sum_{j=0}^{N_\varphi/2}  {\Tdm}^j \left(\frac{1}{N}\sum_{i=0}^{N} f_i\right)
    +
    \sum_{j=1}^{N_\varphi/2}  {\Tdp}^j \left(\frac{1}{N}\sum_{i=0}^{N} f_i\right)\right]
    \nonumber\\
    &=
    \frac{1}{N_\varphi+1} \left[ \sum_{j=0}^{N_\varphi/2}  {\Tdm}^j \bar f(R,Z)
    +
    \sum_{j=1}^{N_\varphi/2}  {\Tdp}^j \bar f(R,Z)\right]
\end{align}
Here, we used that the push-forward operator $\Tdm$ is linear that is $\Tdm f_0 + \Tdm f_1 = \Tdm (f_0+f_1)$
and recover the simple toroidal summation $\bar f$ Eq.~\eqref{eq:toroidal_summation}.
Now, we can see that in the limit $N_\varphi \rightarrow\infty$ the discrete sum represents the integral
of the form
\begin{align}
    \RA{f}_\varphi(R,Z) = \frac{1}{\Delta\varphi}\int_{-\Delta\varphi/2}^{\Delta\varphi/2}\d\varphi \bar f(R(\varphi),Z(\varphi))
\end{align}
A consistency test of this approach is to simply use $\vec B = e_\varphi$. Then
$\Tdpm = 1$ and we recover the original integration $\RA{f}_\varphi= \bar f$.
Now, instead of doing a 0-th order interpolation let us try a linear interpolation along field-lines in between planes that is ( assuming $N_\varphi$ toroidal planes)
\begin{align}
    f(R,Z,\varphi_i + j\delta\varphi) = \left(1-\frac{j}{N_\varphi}\right){\Tdm}^j f_i + \frac{j}{N_\varphi} {\Tdp}^{N_\varphi -j}f_{i+1}
\end{align}
\begin{align}
    \RA{ f}_\varphi &= \frac{1}{N_\varphi N} (( f_0 + (1-\alpha_1)\Tdm f_0 + \alpha_1 (\Tdp)^{N_\varphi -1} f_1 + (1-\alpha_2)(\Tdm)^2 f_0 + \alpha_2 (\Tdp)^{N_\varphi-2} f_1 ...  )+ (f_1 + ...) + ...)\nonumber\\
    &= \frac{1}{ N_\varphi} \sum_{j=0}^{N_\varphi-1}  (1-\alpha_j)(\Tdm)^j \bar f+\alpha_j (\Tdp)^{N_\varphi -j} \bar f
    = \frac{1}{\Delta\varphi}\int_{-\Delta\varphi}^{\Delta\varphi}\d\varphi w(\varphi) \bar f (R(\varphi),Z(\varphi))
    \label{eq:cta}
\end{align}
with $\alpha_j = \frac{j}{N_\varphi}$ and $w(\varphi)$ a linear weight function (pyramid shape) with $\int_{-\Delta\varphi}^{\Delta\varphi} w(\varphi) = \Delta\varphi$. Taking $\Tdpm=1$ again leads to the old result.


Now, an interesting question is, what happens if we are trying to apply the above
results to a function that is not field-aligned like $B(R,Z)$ of $\vec K\cn\psi_p$ for instance? For those functions $\bar f_\mathrm{old}$ actually yields the exact
result, while the convolution is an approximation.
Here, we have to test.
Typically, the functions that we use are slowly varying in $R$ and $Z$ and
so the convolution should not change the result too much.
A good test candidate is still $\langle \mathcal K(\psi_p)\rangle_{\psi_p}=0$.

In all practical tests so far the flux-suface average is not or only very slightly changed by this procedure.
This means that it is not
necessary to follow the smoothing procedure if one is only interested in the flux-surface average.
This makes sense because the toroidal and poloidal averages commute.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Alternative flux labels} \label{sec:alternative}
We find the toroidal flux $\psi_t$ by integrating the q-profile $\psi_t = \int^{\psi_p} \d\psi_p q(\psi_p)$. Since $q$ diverges, $\psi_t$, in contrast to $\psi_p$,
is not defined outside the last closed flux-surface (but has a finite value on the last closed flux surface). We now define the normalized poloidal and toroidal flux labels $\rho_p$ and $\rho_t$
\begin{align}
    \rho_p&:= \sqrt{1-\frac{\psi_p }{\psi_{p,O}}} \ \leftrightarrow\ \psi_p = (1-\rho_p^2)\psi_{p,O} \\
    \rho_t&:= \sqrt{\frac{\psi_t}{\psi_{t,\mathrm{sep}}}},\\
    \text{with }\psi_{p,O} &= \psi_p(R_O, Z_O)% \text{ and } \psi_{p,X} = \psi_p(R_X, Z_X)
\end{align}
where $R_O$, $Z_O$ are the coordinates of the O-point.
The labels $\rho_t$ and $\rho_p$ are useful because
equidistant $\rho_p$ and $\rho_t$ values tend to translate to equidistant flux-surfaces
in configuration space.

\subsection{Manufactured Solution} \label{sec:manufactured}
In order to test the implementation we manufacture a solution to
Eqs.~\eqref{eq:Egyrofluid} and \eqref{eq:elliptic} of the form
\begin{align*}
\phi(R,Z,\varphi,t) &:= \sin(3\pi(R-R_0))\sin(3\pi Z)\sin(3\varphi)\sin(3\pi t)/5; \\
\psi(R,Z,\varphi,t) &:= \sin(3\pi(R-R_0))\sin(3\pi Z)\sin(3\varphi)\sin(3\pi t)/5 = \gamma_{\phi}; \\
n_e(R,Z,\varphi, t) &:= 1 + 0.5\sin(\pi(R-R_0))\sin(\pi Z)\sin(\varphi)\sin(\pi t) \\
{N_i}(R,Z,\varphi,t) &:= 1 + 0.25 \sin(\pi(R-R_0))\sin(\pi Z)\sin(\varphi)\sin(\pi t) = \gamma_{N_i} \\
u_{\parallel,e}(R,Z,\varphi, t) &:= \sin(2\pi(R-R_0))\sin(2\pi Z)\sin(2\varphi)\sin(2\pi t)/(3\sqrt{-\mu_e}) \\
U_{\parallel,i}(R,Z,\varphi, t) &:= \sin(2\pi(R-R_0))\sin(2\pi Z)\sin(2\varphi)\sin(2\pi t)/(3) \\
A_\parallel( R,Z,\varphi,t) &:= \beta( U_{\parallel,i} - u_{\parallel,e})
\end{align*}
We choose circular flux surfaces of the form
\begin{align*}
\psi_p(R,Z) :=0.5((R-R_0)^2 + Z^2),\quad
I_p(R,Z):=I_0
\end{align*}
with $R_0=10$ and $I_0=20$ and a simulation box
$[R_0-a,R_0+a]\times[-a,a]\times[0,2\pi]$.
We then insert these solutions into Eqs.~\eqref{eq:Egyrofluid} and
\eqref{eq:elliptic} and symbolically compute (with the help of Mathematica) the
remainder as source terms that are stored as C-code in the file
\mintinline{c}{manufactured.h}. We insert these source terms to the right hand
side of the corresponding equation in code and simulate for a small time-span.
By comparing the numerical solution to the manufactured one we can observe the
convergence of our numerical methods.
\begin{tcolorbox}[title=Note]
    In order to better distinguish the convergence of the DG discretized terms
    from our parallel derivative we can selectively choose to only activate
    perpendicular (including $A_\parallel$ terms) or parallel terms (those that
    involve derivatives along $\bhat$).
\end{tcolorbox}

Unfortunately, we were unable to find a closed solution for the energy integrals with the above fields.
\begin{tcolorbox}[title=Note]
    The program \mintinline{bash}{manufactured} ignores the "init" parameter
    in the input file and must be used with a circular magnetic field equilibrium
    in combination with "wall", "sheath" and "source" set as "none" or "zero".
    Further, we have the "regularization" of "order" : 1 and we have the same
    diffusion for density and velocity.
    % Check exact equations that are solved!
\end{tcolorbox}

\section{Troubleshooting} \label{sec:troubleshooting}
All previously mentioned codes can crash for various reasons. Here,
we list and describe situations, which generally may lead to program
termination
\begin{longtable}{p{6cm}p{8cm}}
\toprule
\rowcolor{gray!50}\textbf{Error condition} &  \textbf{Handling} \\ \midrule
An input file does not exist or is otherwise invalid
&
Program terminates with an error message to \mintinline{c}{std::cerr}. \mintinline{bash}{feltordiag.cu} writes an error to \mintinline{c}{std::cerr} and continues with the next input file.
    \\
An input netcdf file misses a required field
&
Program terminates with a NetCDF error message to \mintinline{c}{std::cerr}
    \\
No write permission for the output file location
&
Program terminates with an error message to \mintinline{c}{std::cerr}
    \\
An input Json file misses a key or contains a typo in a key
&
Program will exit with an error message. (The reason why we do not
silently use the default value is that the danger of wasting
valuable computing time on the cluster due to a typo is bigger than the
added convenience. We want to be sure that the program
does what the user wants).
The other programs just issue warnings
if a key is not found and use a default value
which is $0$ if not otherwise specified.
    \\
    An input Json file has an invalid value, e.g. a typo in a string value
&
Invalid values lead to termination with an error message to \mintinline{c}{std::cerr}, once and if program tries to use the value
    \\
    Number of processes in $x$, $y$ and $z$ direction does not match total number of Processes
&
Program terminates with an error message to \mintinline{c}{std::cerr}.
    \\
    $2^{s-1}$ or $c_x$ or $c_y$ does not evenly divide $N_x$ and $N_y$, where $s$ is the number of stages in the multigrid algorithm.
&
Program terminates on thrown error. Make sure the numbers add up.
    \\
    Number of processes in $x$, $y$ and $z$ direction does not evenly divide or is greater or equal $N_x/2^{s-1}$, $N_y/2^{s-1}$ and $N_z$, where $s$ is the number of stages in the multigrid algorithm.
&
Program terminates on failed assert
    \\
An MPI error occurs
&
Program crashes horribly printing cryptic error messages (stack trace) to \mintinline{c}{std::cerr}
    \\
A numerical instability occurs
&
The program terminates usually caused by a NaN exception raised. However,
the cause for the instability has to be determined inspecting the
last output in the output file.
    \\
\qquad large fieldaligned oscillations in $u_{\parallel,e}$ paired with instability in the edge of the box
&
Apply damping region
    \\
\qquad Perpendicular grid oscillations in $u_{\parallel,e}$ and $\Delta_\perp \phi$ in the damping region, symmetric in $\varphi$
&
Increase damping $alpha$, increase damping boundary, make the box larger/smaller, increasing DS refinement might help.
    \\
\qquad Spike in $u_{\parallel,e}$ shortly after simulation start
&
Increase $\nu_\perp$, increase $N_x$, $N_y$, decrease perturbation amplitude
    \\
\qquad Grid oscillations far away from the edge
&
Probably caused by the perpendicular transport that goes unstable. Increase $\nu_\perp$ and/or $N_x$, $N_y$. Increasing DS refinement might also help.
\\
\qquad Oscillations where fieldlines intersect the wall
&
Caused by boundary conditions in FCI method and necessarily underresolved toroidal direction.
Increase $N_z$, decrease $N_x$, $N_y$ or decrease $q$ value by decreasing $\mathcal P_\psi$ in geometry input file
\\
\bottomrule
\end{longtable}
%..................................................................

\bibliography{../common/references}
%..................................................................

\end{document}
